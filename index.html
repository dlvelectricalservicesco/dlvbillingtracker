<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DLV Electrical Services Billing Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for print media */
        @media print {
            .print\:hidden {
                display: none !important;
            }
            .print-area {
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
            }
            body {
                margin: 0;
                padding: 0;
                -webkit-print-color-adjust: exact; /* For printing background colors */
                color-adjust: exact;
            }
            /* Adjust font sizes for print if needed */
            .text-3xl { font-size: 1.5rem; }
            .text-2xl { font-size: 1.25rem; }
            .text-xl { font-size: 1.125rem; }
            .text-lg { font-size: 1rem; }
            .text-base { font-size: 0.875rem; }
            .text-sm { font-size: 0.75rem; }
            .text-xs { font-size: 0.625rem; }

            /* Ensure elements are not cut off */
            .overflow-x-auto, .overflow-y-auto {
                overflow: visible !important;
            }
            table {
                width: 100%;
                table-layout: fixed; /* Helps with column widths */
            }
            th, td {
                white-space: normal; /* Allow text to wrap */
                word-wrap: break-word; /* Break long words */
            }
            /* Specific adjustments for logo positioning in print */
            .print-area .relative img {
                position: absolute;
                top: 0.5rem; /* Adjust as needed for print header */
                left: 0.5rem; /* Adjust as needed for print header */
                max-height: 4rem; /* Smaller logo for print */
            }
            .print-area .pl-32 {
                padding-left: 5rem; /* Adjust text indentation for smaller logo */
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React and ReactDOM CDNs -->
    <!-- Switched to cdnjs for better CORS compatibility -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Define Firebase config globally for the React script to access
        // API Key is intentionally left empty; Canvas will inject it at runtime.
        window.firebaseConfig = {
            apiKey: "AIzaSyD7LhkerFn3EAMRDIE0Da-ko2Cw7lKg6OQ",
            authDomain: "dlvbilling-448fc.firebaseapp.com",
            projectId: "dlvbilling-448fc",
            storageBucket: "dlvbilling-448fc.firebasestorage.app",
            messagingSenderId: "192537723344",
            appId: "1:192537723344:web:cbe9dd0cd7b61a68ebb9d5",
            measurementId: "G-M2MP92KQZ8"
        };

        // Define __app_id and __initial_auth_token globally
        window.__app_id = 'dlvbillingtracker'; // Use your actual app ID
        window.__initial_auth_token = null; // Set to null or your actual token if available

        // Export Firebase functions to the window object so React script can use them
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            collection,
            addDoc,
            onSnapshot,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            arrayUnion,
            arrayRemove,
            deleteDoc
        };
    </script>

    <script type="text/babel">
        // Ensure the entire React application runs only after the window is fully loaded.
        // This helps guarantee that ReactDOM is defined by the time it's accessed.
        window.onload = function() {
            // React and ReactDOM are now guaranteed to be available here
            const { useState, useEffect, createContext, useContext } = React;
            const ReactDOM = window.ReactDOM; // Explicitly get ReactDOM from the window object

            // Access Firebase functions and config from the global window object
            const firebaseConfig = window.firebaseConfig;
            const __app_id = window.__app_id;
            const __initial_auth_token = window.__initial_auth_token;
            const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, addDoc, onSnapshot, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc } = window.firebase;


            // Create a context for Firebase and user data
            const FirebaseContext = createContext(null);

            // Custom hook to use Firebase context
            const useFirebase = () => useContext(FirebaseContext);

            // --- Toast Component ---
            const Toast = ({ message, type, onClose }) => {
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                const borderColor = type === 'success' ? 'border-green-700' : 'border-red-700';

                return (
                    <div className={`fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white ${bgColor} border-b-4 ${borderColor} transition-all duration-300 transform translate-y-0 opacity-100`}>
                        <div className="flex items-center justify-between">
                            <span>{message}</span>
                            <button onClick={onClose} className="ml-4 text-white font-bold text-lg leading-none hover:text-gray-100">
                                &times;
                            </button>
                        </div>
                    </div>
                );
            };

            // Create a Toast Context
            const ToastContext = createContext(null);

            const ToastProvider = ({ children }) => {
                const [toast, setToast] = useState(null);

                const showToast = (message, type = 'success', duration = 3000) => {
                    setToast({ message, type });
                    setTimeout(() => {
                        setToast(null);
                    }, duration);
                };

                return (
                    <ToastContext.Provider value={{ showToast }}>
                        {children}
                        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    </ToastContext.Provider>
                );
            };


            // --- Admin Login Modal Component ---
            const AdminLoginModal = ({ onClose, onLoginSuccess }) => {
                const [password, setPassword] = useState('');
                const [error, setError] = useState('');
                const { showToast } = useContext(ToastContext);

                const handleLogin = () => {
                    // For demonstration purposes, a simple hardcoded password.
                    // In a real application, this would involve secure authentication.
                    if (password === 'admin123') { // Replace with a secure method in production
                        onLoginSuccess();
                        showToast('Admin access granted!', 'success');
                        onClose();
                    } else {
                        setError('Invalid password. Please try again.');
                        showToast('Invalid password.', 'error');
                    }
                };

                return (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform transition-all scale-100 opacity-100">
                            <h3 className="text-xl font-bold mb-4 text-gray-900 border-b pb-2">Admin Login</h3>
                            <div className="space-y-4">
                                <div>
                                    <label htmlFor="adminPassword" className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                    <input
                                        type="password"
                                        id="adminPassword"
                                        value={password}
                                        onChange={(e) => { setPassword(e.target.value); setError(''); }}
                                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                        onKeyPress={(e) => { if (e.key === 'Enter') handleLogin(); }}
                                    />
                                    {error && <p className="mt-1 text-xs text-red-600">{error}</p>}
                                </div>
                                <div className="flex justify-end space-x-3">
                                    <button
                                        onClick={onClose}
                                        className="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleLogin}
                                        className="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                                    >
                                        Login
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };


            // --- Component Definitions (Ordered from child to parent where possible) ---

            const Header = ({ setView, isAdminLoggedIn, onAdminLogout, onAdminLoginClick }) => {
                return (
                    <header className="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg rounded-b-lg">
                        <div className="container mx-auto p-4 flex flex-col sm:flex-row justify-between items-center">
                            <h1 className="text-3xl font-bold mb-4 sm:mb-0">DLV Electrical Services Co.</h1>
                            {/* User ID display removed as requested */}
                            {!isAdminLoggedIn && (
                                <div className="mt-2 sm:mt-0">
                                    <button
                                        onClick={onAdminLoginClick}
                                        className="px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-800 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-600 focus:ring-opacity-50 text-sm sm:text-base font-medium"
                                    >
                                        Admin Login
                                    </button>
                                </div>
                            )}
                        </div>
                        {/* Navigation Bar */}
                        <nav className="bg-blue-700 py-3 shadow-md">
                            <div className="container mx-auto flex flex-wrap justify-center sm:justify-start space-x-2 sm:space-x-4 px-4">
                                <button
                                    onClick={() => setView('dashboard')}
                                    className="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-800 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 text-sm sm:text-base font-medium"
                                >
                                    Dashboard
                                </button>
                                {isAdminLoggedIn && (
                                    <>
                                        <button
                                            onClick={() => setView('projects')}
                                            className="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-800 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 text-sm sm:text-base font-medium"
                                        >
                                            Projects
                                        </button>
                                        <button
                                            onClick={() => setView('templateEditor')}
                                            className="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 text-sm sm:text-base font-medium"
                                        >
                                            Template
                                        </button>
                                        <button
                                            onClick={() => setView('createBilling')}
                                            className="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 text-sm sm:text-base font-medium"
                                        >
                                            Create Billing
                                        </button>
                                        <button
                                            onClick={() => setView('createExpenseReport')}
                                            className="px-4 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50 text-sm sm:text-base font-medium"
                                        >
                                            Create Expenses Report
                                        </button>
                                        <button
                                            onClick={onAdminLogout}
                                            className="px-4 py-2 rounded-lg bg-gray-500 text-white hover:bg-gray-600 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 text-sm sm:text-base font-medium"
                                        >
                                            Admin Logout
                                        </button>
                                    </>
                                )}
                            </div>
                        </nav>
                    </header>
                );
            };

            const DashboardCard = ({ title, value, icon }) => (
                <div className="bg-white p-5 rounded-lg shadow-md flex items-center justify-between border border-gray-200">
                    <div>
                        <h3 className="text-sm font-medium text-gray-500 uppercase">{title}</h3>
                        <p className="text-3xl font-bold text-gray-900 mt-1">{value}</p>
                    </div>
                    <div className="text-4xl text-blue-500">{icon}</div>
                </div>
            );

            const Modal = ({ title, message, onConfirm, onCancel }) => {
                return (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform transition-all scale-100 opacity-100">
                            <h3 className="text-xl font-bold mb-4 text-gray-900 border-b pb-2">{title}</h3>
                            <p className="text-gray-700 mb-6">{message}</p>
                            <div className="flex justify-end space-x-3">
                                <button
                                    onClick={onCancel}
                                    className="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={onConfirm}
                                    className="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50"
                                >
                                    Confirm
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const AddRecordModal = ({ title, onClose, onSave, type }) => {
                const [amount, setAmount] = useState('');
                const [description, setDescription] = useState('');
                const [date, setDate] = useState(new Date().toISOString().slice(0, 10)); // Default to today
                const [modeOfPayment, setModeOfPayment] = useState('Cash'); // Default mode of payment for payments
                const [paymentType, setPaymentType] = useState('Payment'); // New: Default payment type
                const [bankName, setBankName] = useState('');
                const [checkNo, setCheckNo] = useState('');
                const [transactionNo, setTransactionNo] = useState('');
                const [expenseType, setExpenseType] = useState('Material Expenses'); // New: Default expense type
                const [deliveryRecipientNo, setDeliveryRecipientNo] = useState(''); // New state for expenses
                const [errors, setErrors] = useState({});
                const { showToast } = useContext(ToastContext); // Use ToastContext

                const validateForm = () => {
                    const newErrors = {};
                    if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                        newErrors.amount = `${type === 'payment' || type === 'additional' ? 'Amount' : 'Expense'} must be a positive number.`;
                    }
                    if (!date) {
                        newErrors.date = 'Date is required.';
                    }
                    if (type === 'payment') {
                        if (modeOfPayment === 'Check') {
                            if (!bankName.trim()) newErrors.bankName = 'Bank Name is required for Check payments.';
                            if (!checkNo.trim()) newErrors.checkNo = 'Check No. is required for Check payments.';
                        } else if (modeOfPayment === 'Bank Transfer') {
                            if (!bankName.trim()) newErrors.bankName = 'Bank Name is required for Bank Transfer.';
                            if (!transactionNo.trim()) newErrors.transactionNo = 'Transaction No. is required for Bank Transfer.';
                        }
                        if (!paymentType) newErrors.paymentType = 'Payment Type is required.';
                    }
                    if (type === 'expense') {
                        if (!expenseType) newErrors.expenseType = 'Expense Type is required.';
                    }
                    setErrors(newErrors);
                    return Object.keys(newErrors).length === 0;
                };

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (validateForm()) {
                        const recordData = {
                            amount: parseFloat(amount),
                            description: description.trim() || `General ${type}`,
                            date: date,
                            createdAt: new Date().toISOString(),
                        };

                        if (type === 'payment') {
                            recordData.modeOfPayment = modeOfPayment;
                            recordData.paymentType = paymentType; // Include payment type
                            if (modeOfPayment === 'Check') {
                                recordData.bankName = bankName.trim();
                                recordData.checkNo = checkNo.trim();
                            } else if (modeOfPayment === 'Bank Transfer') {
                                recordData.bankName = bankName.trim();
                                recordData.transactionNo = transactionNo.trim();
                            }
                        } else if (type === 'expense') {
                            recordData.expenseType = expenseType; // Include expense type
                            recordData.deliveryRecipientNo = deliveryRecipientNo.trim();
                        }
                        onSave(recordData);
                        showToast(`${title} added successfully!`, 'success');
                    } else {
                        showToast('Please correct form errors.', 'error');
                    }
                };

                return (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform transition-all scale-100 opacity-100">
                            <h3 className="text-xl font-bold mb-4 text-gray-900 border-b pb-2">{title}</h3>
                            <div className="overflow-y-auto max-h-[70vh] pr-2">
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    {type === 'payment' && (
                                        <>
                                            <div>
                                                <label htmlFor="paymentType" className="block text-sm font-medium text-gray-700 mb-1">Payment Type</label>
                                                <select
                                                    id="paymentType"
                                                    value={paymentType}
                                                    onChange={(e) => { setPaymentType(e.target.value); setErrors(prev => ({ ...prev, paymentType: '' })); }}
                                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                                >
                                                    <option value="Payment">Payment</option>
                                                    <option value="Downpayment">Downpayment</option>
                                                    <option value="Partial Payment">Partial Payment</option>
                                                </select>
                                                {errors.paymentType && <p className="mt-1 text-xs text-red-600">{errors.paymentType}</p>}
                                            </div>
                                            <div>
                                                <label htmlFor="modeOfPayment" className="block text-sm font-medium text-gray-700 mb-1">Mode of Payment</label>
                                                <select
                                                    id="modeOfPayment"
                                                    value={modeOfPayment}
                                                    onChange={(e) => {
                                                        setModeOfPayment(e.target.value);
                                                        setBankName('');
                                                        setCheckNo('');
                                                        setTransactionNo('');
                                                        setErrors(prev => ({ ...prev, modeOfPayment: '', bankName: '', checkNo: '', transactionNo: '' }));
                                                    }}
                                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                                >
                                                    <option value="Cash">Cash</option>
                                                    <option value="Check">Check</option>
                                                    <option value="Bank Transfer">Bank Transfer</option>
                                                </select>
                                            </div>
                                        </>
                                    )}

                                    {(modeOfPayment === 'Check' || modeOfPayment === 'Bank Transfer') && type === 'payment' && (
                                        <div>
                                            <label htmlFor="bankName" className="block text-sm font-medium text-gray-700 mb-1">Bank Name</label>
                                            <input
                                                type="text"
                                                id="bankName"
                                                value={bankName}
                                                onChange={(e) => { setBankName(e.target.value); setErrors(prev => ({ ...prev, bankName: '' })); }}
                                                className={`mt-1 block w-full px-3 py-2 border ${errors.bankName ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                                                required
                                            />
                                            {errors.bankName && <p className="mt-1 text-xs text-red-600">{errors.bankName}</p>}
                                        </div>
                                    )}

                                    {modeOfPayment === 'Check' && type === 'payment' && (
                                        <div>
                                            <label htmlFor="checkNo" className="block text-sm font-medium text-gray-700 mb-1">Check No.</label>
                                            <input
                                                type="text"
                                                id="checkNo"
                                                value={checkNo}
                                                onChange={(e) => { setCheckNo(e.target.value); setErrors(prev => ({ ...prev, checkNo: '' })); }}
                                                className={`mt-1 block w-full px-3 py-2 border ${errors.checkNo ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                                                required
                                            />
                                            {errors.checkNo && <p className="mt-1 text-xs text-red-600">{errors.checkNo}</p>}
                                        </div>
                                    )}

                                    {modeOfPayment === 'Bank Transfer' && type === 'payment' && (
                                        <div>
                                            <label htmlFor="transactionNo" className="block text-sm font-medium text-gray-700 mb-1">Transaction No.</label>
                                            <input
                                                type="text"
                                                id="transactionNo"
                                                value={transactionNo}
                                                onChange={(e) => { setTransactionNo(e.target.value); setErrors(prev => ({ ...prev, transactionNo: '' })); }}
                                                className={`mt-1 block w-full px-3 py-2 border ${errors.transactionNo ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:focus:border-blue-500 sm:text-sm`}
                                                required
                                            />
                                            {errors.transactionNo && <p className="mt-1 text-xs text-red-600">{errors.transactionNo}</p>}
                                        </div>
                                    )}

                                    {type === 'expense' && (
                                        <>
                                            <div>
                                                <label htmlFor="expenseType" className="block text-sm font-medium text-gray-700 mb-1">Expense Type</label>
                                                <select
                                                    id="expenseType"
                                                    value={expenseType}
                                                    onChange={(e) => { setExpenseType(e.target.value); setErrors(prev => ({ ...prev, expenseType: '' })); }}
                                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                                >
                                                    <option value="Material Expenses">Material Expenses</option>
                                                    <option value="Payroll Expenses">Payroll Expenses</option>
                                                    <option value="Other Expenses">Other Expenses</option>
                                                </select>
                                                {errors.expenseType && <p className="mt-1 text-xs text-red-600">{errors.expenseType}</p>}
                                            </div>
                                            <div>
                                                <label htmlFor="deliveryRecipientNo" className="block text-sm font-sm font-medium text-gray-700 mb-1">Delivery Recipient No. (Optional)</label>
                                                <input
                                                    type="text"
                                                    id="deliveryRecipientNo"
                                                    value={deliveryRecipientNo}
                                                    onChange={(e) => setDeliveryRecipientNo(e.target.value)}
                                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                                />
                                            </div>
                                        </>
                                    )}

                                    <div>
                                        <label htmlFor="recordAmount" className="block text-sm font-medium text-gray-700 mb-1">Amount (â‚±)</label>
                                        <input
                                            type="number"
                                            id="recordAmount"
                                            value={amount}
                                            onChange={(e) => { setAmount(e.target.value); setErrors(prev => ({ ...prev, amount: '' })); }}
                                            step="0.01"
                                            min="0"
                                            className={`mt-1 block w-full px-3 py-2 border ${errors.amount ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                                            required
                                        />
                                        {errors.amount && <p className="mt-1 text-xs text-red-600">{errors.amount}</p>}
                                    </div>
                                    <div>
                                        <label htmlFor="recordDate" className="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                        <input
                                            type="date"
                                            id="recordDate"
                                            value={date}
                                            onChange={(e) => { setDate(e.target.value); setErrors(prev => ({ ...prev, date: '' })); }}
                                            className={`mt-1 block w-full px-3 py-2 border ${errors.date ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                                            required
                                        />
                                        {errors.date && <p className="mt-1 text-xs text-red-600">{errors.date}</p>}
                                    </div>
                                    <div>
                                        <label htmlFor="recordDescription" className="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
                                        <textarea
                                            id="recordDescription"
                                            value={description}
                                            onChange={(e) => setDescription(e.target.value)}
                                            rows="3"
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                        ></textarea>
                                    </div>
                                    <div className="flex justify-end space-x-3 mt-6">
                                        <button
                                            type="button"
                                            onClick={onClose}
                                            className="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            className={`px-4 py-2 rounded-lg ${type === 'payment' ? 'bg-blue-600 hover:bg-blue-700' : type === 'expense' ? 'bg-red-600 hover:bg-red-700' : 'bg-purple-600 hover:bg-purple-700'} text-white transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-opacity-50 ${type === 'payment' ? 'focus:ring-blue-500' : type === 'expense' ? 'focus:ring-red-500' : 'focus:ring-purple-500'}`}
                                        >
                                            Add {type === 'payment' ? 'Payment' : type === 'expense' ? 'Expense' : 'Additional'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            };

            const Dashboard = ({ setView, setSelectedProjectId, isAdminLoggedIn }) => {
                const { db, userId, isAuthReady } = useFirebase();
                const [projects, setProjects] = useState([]);
                const [loading, setLoading] = useState(true);
                const [error, setError] = useState(null);
                const { showToast } = useContext(ToastContext); // Use ToastContext

                useEffect(() => {
                    if (!isAuthReady || !db || !userId) return;

                    const projectsColRef = collection(db, `artifacts/${__app_id}/users/${userId}/projects`);
                    const unsubscribe = onSnapshot(projectsColRef, (snapshot) => {
                        const projectsData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setProjects(projectsData);
                        setLoading(false);
                    }, (err) => {
                        console.error("Error fetching projects for dashboard:", err);
                        setError("Failed to load dashboard data.");
                        showToast("Failed to load dashboard data.", "error");
                        setLoading(false);
                    });

                    return () => unsubscribe();
                }, [db, userId, isAuthReady, showToast]);

                if (loading) return <div className="text-center py-8">Loading dashboard...</div>;
                if (error) return <div className="text-center py-8 text-red-600">{error}</div>;

                const totalProjects = projects.length;
                const completedProjects = projects.filter(p => {
                    const totalPaid = p.payments ? p.payments.reduce((sum, payment) => sum + payment.amount, 0) : 0;
                    return totalPaid >= p.contractAmount;
                }).length;
                const inProgressProjects = totalProjects - completedProjects;

                const totalContractAmount = projects.reduce((sum, p) => sum + (p.contractAmount || 0), 0);
                // const totalExpenses = projects.reduce((sum, p) => sum + (p.expenses ? p.expenses.reduce((expSum, exp) => expSum + exp.amount, 0) : 0), 0); // Removed as requested

                return (
                    <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h2 className="text-2xl font-bold mb-6 text-gray-900 border-b pb-3">Dashboard Overview</h2>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"> {/* Adjusted grid for removed card */}
                            <DashboardCard title="Total Projects" value={totalProjects} icon="ðŸ“Š" />
                            <DashboardCard title="Projects In Progress" value={inProgressProjects} icon="ðŸš§" />
                            <DashboardCard title="Completed Projects" value={completedProjects} icon="âœ…" />
                            <DashboardCard title="Total Contract Value" value={`â‚±${totalContractAmount.toLocaleString()}`} icon="ðŸ’°" />
                        </div>

                        {/* Financial Summary section removed as requested */}

                        <h3 className="text-xl font-bold mb-4 text-gray-900">Recent Projects</h3>
                        {projects.length === 0 ? (
                            <p className="text-gray-600">No projects found.
                                {isAdminLoggedIn && (
                                    <button onClick={() => setView('newProject')} className="text-blue-600 hover:underline ml-1">Add a new project</button>
                                )}
                                {!isAdminLoggedIn && (
                                    <span> Please log in as admin to add projects.</span>
                                )}
                            </p>
                        ) : (
                            <div className="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project Name</th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client Name</th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contract Amount</th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                                            <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {projects.slice(0, 5).map(project => { // Show top 5 recent projects
                                            const totalPaid = project.payments ? project.payments.reduce((sum, payment) => sum + payment.amount, 0) : 0;
                                            const progressPercentage = project.contractAmount > 0 ? ((totalPaid / project.contractAmount) * 100).toFixed(0) : 0;
                                            return (
                                                <tr key={project.id}>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{project.projectName}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{project.clientName}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">â‚±{project.contractAmount.toLocaleString()}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                        <div className="w-24 bg-gray-200 rounded-full h-2.5">
                                                            <div className="bg-blue-600 h-2.5 rounded-full" style={{ width: `${progressPercentage}%` }}></div>
                                                        </div>
                                                        <span className="ml-2 text-xs">{progressPercentage}% Paid</span>
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                        <button
                                                            onClick={() => { setSelectedProjectId(project.id); setView('projectDetail'); }}
                                                            className="text-blue-600 hover:text-blue-900 hover:underline transition duration-150 ease-in-out"
                                                        >
                                                            View
                                                        </button>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}
                        <div className="mt-6 text-center">
                            <button
                                onClick={() => setView('projects')}
                                className="px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                            >
                                View All Projects
                            </button>
                        </div>
                        {/* Admin Login button removed from here */}
                    </div>
                );
            };


            const Projects = ({ setView, setSelectedProjectId, isAdminLoggedIn }) => {
                const { db, userId, isAuthReady } = useFirebase();
                const [projects, setProjects] = useState([]);
                const [loading, setLoading] = useState(true);
                const [error, setError] = useState(null);
                const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
                const [projectToDelete, setProjectToDelete] = useState(null);
                const { showToast } = useContext(ToastContext); // Use ToastContext

                useEffect(() => {
                    if (!isAuthReady || !db || !userId) return;

                    const projectsColRef = collection(db, `artifacts/${__app_id}/users/${userId}/projects`);
                    const unsubscribe = onSnapshot(projectsColRef, (snapshot) => {
                        const projectsData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setProjects(projectsData);
                        setLoading(false);
                    }, (err) => {
                        console.error("Error fetching projects:", err);
                        setError("Failed to load projects.");
                        showToast("Failed to load projects.", "error");
                        setLoading(false);
                    });

                    return () => unsubscribe();
                }, [db, userId, isAuthReady, showToast]);

                const handleDeleteClick = (project) => {
                    setProjectToDelete(project);
                    setShowDeleteConfirm(true);
                };

                const confirmDelete = async () => {
                    if (!db || !userId || !projectToDelete) return;
                    try {
                        const projectDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/projects`, projectToDelete.id);
                        await deleteDoc(projectDocRef);
                        setShowDeleteConfirm(false);
                        setProjectToDelete(null);
                        showToast(`Project "${projectToDelete.projectName}" deleted successfully!`, 'success');
                    } catch (err) {
                        console.error("Error deleting project:", err);
                        setError("Failed to delete project.");
                        showToast("Failed to delete project.", "error");
                    }
                };

                const cancelDelete = () => {
                    setShowDeleteConfirm(false);
                    setProjectToDelete(null);
                };

                if (loading) return <div className="text-center py-8">Loading projects...</div>;
                if (error) return <div className="text-center py-8 text-red-600">{error}</div>;

                return (
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <h2 className="text-2xl font-bold mb-6 text-gray-900 border-b pb-3">All Projects</h2>

                        {isAdminLoggedIn && (
                            <div className="mb-6 flex justify-end">
                                <button
                                    onClick={() => setView('newProject')}
                                    className="px-5 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50"
                                >
                                    Add New Project
                                </button>
                            </div>
                        )}

                        {projects.length === 0 ? (
                            <p className="text-gray-600 text-center py-10">No projects listed yet.
                                {isAdminLoggedIn && (
                                    <button onClick={() => setView('newProject')} className="text-blue-600 hover:underline ml-1">Click here to add a new project!</button>
                                )}
                                {!isAdminLoggedIn && (
                                    <span> Please log in as admin to add projects.</span>
                                )}
                            </p>
                        ) : (
                            <div className="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project Name</th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client Name</th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contract No.</th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date of Contract</th>
                                            <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contract Amount</th>
                                            <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {projects.map(project => (
                                            <tr key={project.id}>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{project.projectName}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{project.clientName}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{project.contractNo}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{project.dateOfContract}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">â‚±{project.contractAmount.toLocaleString()}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                    <button
                                                        onClick={() => { setSelectedProjectId(project.id); setView('projectDetail'); }}
                                                        className="text-blue-600 hover:text-blue-900 hover:underline mr-4 transition duration-150 ease-in-out"
                                                    >
                                                        View Details
                                                    </button>
                                                    {isAdminLoggedIn && (
                                                        <>
                                                            <button
                                                                onClick={() => { setSelectedProjectId(project.id); setView('editProject'); }} // New Edit button
                                                                className="text-yellow-600 hover:text-yellow-900 hover:underline mr-4 transition duration-150 ease-in-out"
                                                            >
                                                                Edit
                                                            </button>
                                                            <button
                                                                onClick={() => handleDeleteClick(project)}
                                                                className="text-red-600 hover:text-red-900 hover:underline transition duration-150 ease-in-out"
                                                            >
                                                                Delete
                                                            </button>
                                                        </>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {showDeleteConfirm && (
                            <Modal
                                title="Confirm Deletion"
                                message={`Are you sure you want to delete project "${projectToDelete?.projectName}"? This action cannot be undone.`}
                                onConfirm={confirmDelete}
                                onCancel={cancelDelete}
                            />
                        )}
                    </div>
                );
            };

            // Renamed from NewProjectForm to ProjectForm to handle both add and edit
            const ProjectForm = ({ projectId, setView, setSelectedProjectId }) => {
                const { db, userId, isAuthReady } = useFirebase();
                const [formData, setFormData] = useState({
                    projectName: '',
                    clientName: '',
                    contractNo: '',
                    dateOfContract: '',
                    contractAmount: '',
                });
                const [errors, setErrors] = useState({});
                const [isSubmitting, setIsSubmitting] = useState(false);
                const [message, setMessage] = useState({ type: '', text: '' });
                const isEditMode = !!projectId; // Determine if in edit mode
                const { showToast } = useContext(ToastContext); // Use ToastContext

                useEffect(() => {
                    if (!isAuthReady || !db || !userId) return;

                    if (isEditMode) {
                        const projectDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/projects`, projectId);
                        const fetchProject = async () => {
                            try {
                                const docSnap = await getDoc(projectDocRef);
                                if (docSnap.exists()) {
                                    setFormData(docSnap.data());
                                } else {
                                    setMessage({ type: 'error', text: 'Project not found for editing.' });
                                    showToast('Project not found for editing.', 'error');
                                    setTimeout(() => setView('projects'), 1500); // Redirect if not found
                                }
                            } catch (err) {
                                console.error("Error fetching project for edit:", err);
                                setMessage({ type: 'error', text: 'Failed to load project for editing.' });
                                showToast('Failed to load project for editing.', 'error');
                            }
                        };
                        fetchProject();
                    } else {
                        // Reset form for new project if not in edit mode
                        setFormData({
                            projectName: '',
                            clientName: '',
                            contractNo: '',
                            dateOfContract: '',
                            contractAmount: '',
                        });
                    }
                }, [db, userId, isAuthReady, projectId, isEditMode, setView, showToast]);

                const handleChange = (e) => {
                    const { name, value } = e.target;
                    setFormData(prev => ({ ...prev, [name]: value }));
                    setErrors(prev => ({ ...prev, [name]: '' })); // Clear error on change
                };

                const validateForm = () => {
                    const newErrors = {};
                    if (!formData.projectName.trim()) newErrors.projectName = 'Project Name is required.';
                    if (!formData.clientName.trim()) newErrors.clientName = 'Client Name is required.';
                    if (!formData.contractNo.trim()) newErrors.contractNo = 'Contract No. is required.';
                    if (!formData.dateOfContract) newErrors.dateOfContract = 'Date of Contract is required.';
                    if (!formData.contractAmount || isNaN(formData.contractAmount) || parseFloat(formData.contractAmount) <= 0) {
                        newErrors.contractAmount = 'Contract Amount must be a positive number.';
                    }
                    setErrors(newErrors);
                    return Object.keys(newErrors).length === 0;
                };

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    setMessage({ type: '', text: '' }); // Clear previous messages

                    if (!validateForm()) {
                        setMessage({ type: 'error', text: 'Please correct the errors in the form.' });
                        showToast('Please correct the errors in the form.', 'error');
                        return;
                    }

                    if (!isAuthReady || !db || !userId) {
                        setMessage({ type: 'error', text: 'Authentication not ready. Please try again.' });
                        showToast('Authentication not ready. Please try again.', 'error');
                        return;
                    }

                    setIsSubmitting(true);
                    try {
                        if (isEditMode) {
                            const projectDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/projects`, projectId);
                            await updateDoc(projectDocRef, {
                                ...formData,
                                contractAmount: parseFloat(formData.contractAmount),
                            });
                            setMessage({ type: 'success', text: 'Project updated successfully!' });
                            showToast('Project updated successfully!', 'success');
                        } else {
                            const projectsColRef = collection(db, `artifacts/${__app_id}/users/${userId}/projects`);
                            await addDoc(projectsColRef, {
                                ...formData,
                                contractAmount: parseFloat(formData.contractAmount),
                                payments: [],
                                expenses: [],
                                contractAdditions: [],
                                createdAt: new Date().toISOString(),
                            });
                            setMessage({ type: 'success', text: 'Project added successfully!' });
                            showToast('Project added successfully!', 'success');
                        }
                        setTimeout(() => {
                            setView('projects');
                            setSelectedProjectId(null); // Clear selected project after saving
                        }, 1500);
                    } catch (err) {
                        console.error("Error saving project: ", err);
                        setMessage({ type: 'error', text: `Failed to ${isEditMode ? 'update' : 'add'} project. Please try again.` });
                        showToast(`Failed to ${isEditMode ? 'update' : 'add'} project.`, 'error');
                    } finally {
                        setIsSubmitting(false);
                    }
                };

                return (
                    <div className="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
                        <h2 className="text-2xl font-bold mb-6 text-gray-900 border-b pb-3">
                            {isEditMode ? 'Edit Project' : 'Add New Project'}
                        </h2>

                        {message.text && (
                            <div className={`p-3 mb-4 rounded-md text-sm ${message.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                {message.text}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label htmlFor="projectName" className="block text-sm font-medium text-gray-700 mb-1">Project Name</label>
                                <input
                                    type="text"
                                    id="projectName"
                                    name="projectName"
                                    value={formData.projectName}
                                    onChange={handleChange}
                                    className={`mt-1 block w-full px-3 py-2 border ${errors.projectName ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                                    required
                                />
                                {errors.projectName && <p className="mt-1 text-xs text-red-600">{errors.projectName}</p>}
                            </div>

                            <div>
                                <label htmlFor="clientName" className="block text-sm font-medium text-gray-700 mb-1">Client Name</label>
                                <input
                                    type="text"
                                    id="clientName"
                                    name="clientName"
                                    value={formData.clientName}
                                    onChange={handleChange}
                                    className={`mt-1 block w-full px-3 py-2 border ${errors.clientName ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                                    required
                                />
                                {errors.clientName && <p className="mt-1 text-xs text-red-600">{errors.clientName}</p>}
                            </div>

                            <div>
                                <label htmlFor="contractNo" className="block text-sm font-medium text-gray-700 mb-1">Contract No.</label>
                                <input
                                    type="text"
                                    id="contractNo"
                                    name="contractNo"
                                    value={formData.contractNo}
                                    onChange={handleChange}
                                    className={`mt-1 block w-full px-3 py-2 border ${errors.contractNo ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                                    required
                                />
                                {errors.contractNo && <p className="mt-1 text-xs text-red-600">{errors.contractNo}</p>}
                            </div>

                            <div>
                                <label htmlFor="dateOfContract" className="block text-sm font-medium text-gray-700 mb-1">Date of Contract</label>
                                <input
                                    type="date"
                                    id="dateOfContract"
                                    name="dateOfContract"
                                    value={formData.dateOfContract}
                                    onChange={handleChange}
                                    className={`mt-1 block w-full px-3 py-2 border ${errors.dateOfContract ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                                    required
                                />
                                {errors.dateOfContract && <p className="mt-1 text-xs text-red-600">{errors.dateOfContract}</p>}
                            </div>

                            <div>
                                <label htmlFor="contractAmount" className="block text-sm font-medium text-gray-700 mb-1">Contract Amount (â‚±)</label>
                                <input
                                    type="number"
                                    id="contractAmount"
                                    name="contractAmount"
                                    value={formData.contractAmount}
                                    onChange={handleChange}
                                    step="0.01"
                                    min="0"
                                    className={`mt-1 block w-full px-3 py-2 border ${errors.contractAmount ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                                    required
                                />
                                {errors.contractAmount && <p className="mt-1 text-xs text-red-600">{errors.contractAmount}</p>}
                            </div>

                            <div className="flex justify-end space-x-3 mt-6">
                                <button
                                    type="button"
                                    onClick={() => { setView('projects'); setSelectedProjectId(null); }}
                                    className="px-5 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"
                                    disabled={isSubmitting}
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    className="px-5 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled={isSubmitting}
                                >
                                    {isSubmitting ? 'Saving...' : (isEditMode ? 'Save Changes' : 'Add Project')}
                                </button>
                            </div>
                        </form>
                    </div>
                );
            };

            const ProjectDetail = ({ projectId, setView, isAdminLoggedIn }) => {
                const { db, userId, isAuthReady } = useFirebase();
                const [project, setProject] = useState(null);
                const [loading, setLoading] = useState(true);
                const [error, setError] = useState(null);
                const [showAddPaymentModal, setShowAddPaymentModal] = useState(false);
                const [showAddExpenseModal, setShowAddExpenseModal] = useState(false);
                const [showAddAdditionalModal, setShowAddAdditionalModal] = useState(false); // New state for additionals modal
                const [showDeleteConfirm, setShowDeleteConfirm] = useState(false); // Generic delete confirm
                const [itemToDelete, setItemToDelete] = useState(null); // Item to delete
                const [deleteType, setDeleteType] = useState(''); // 'payment', 'expense', 'additional'
                const { showToast } = useContext(ToastContext); // Use ToastContext


                useEffect(() => {
                    if (!isAuthReady || !db || !userId) return;

                    const projectDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/projects`, projectId);
                    const unsubscribe = onSnapshot(projectDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            setProject({ id: docSnap.id, ...docSnap.data() });
                        } else {
                            setError("Project not found.");
                            showToast("Project not found.", "error");
                        }
                        setLoading(false);
                    }, (err) => {
                        console.error("Error fetching project details:", err);
                        setError("Failed to load project details.");
                        showToast("Failed to load project details.", "error");
                        setLoading(false);
                    });

                    return () => unsubscribe();
                }, [db, userId, isAuthReady, projectId, showToast]);

                const handleAddPayment = async (paymentData) => {
                    if (!db || !userId || !projectId) return;
                    try {
                        const projectDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/projects`, projectId);
                        await updateDoc(projectDocRef, {
                            payments: arrayUnion(paymentData)
                        });
                        setShowAddPaymentModal(false);
                        showToast('Payment added successfully!', 'success');
                    } catch (err) {
                        console.error("Error adding payment:", err);
                        showToast('Failed to add payment.', 'error');
                    }
                };

                const handleDeleteClick = (item, type) => {
                    setItemToDelete(item);
                    setDeleteType(type);
                    setShowDeleteConfirm(true);
                };

                const confirmDelete = async () => {
                    if (!db || !userId || !projectId || !itemToDelete) return;
                    try {
                        const projectDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/projects`, projectId);
                        if (deleteType === 'payment') {
                            await updateDoc(projectDocRef, {
                                payments: arrayRemove(itemToDelete)
                            });
                            showToast('Payment deleted successfully!', 'success');
                        } else if (deleteType === 'expense') {
                            await updateDoc(projectDocRef, {
                                expenses: arrayRemove(itemToDelete)
                            });
                            showToast('Expense deleted successfully!', 'success');
                        } else if (deleteType === 'additional') {
                            const currentProjectSnap = await getDoc(projectDocRef);
                            if (currentProjectSnap.exists()) {
                                const currentProject = currentProjectSnap.data();
                                const newContractAmount = (currentProject.contractAmount || 0) - itemToDelete.amount;
                                await updateDoc(projectDocRef, {
                                    contractAmount: newContractAmount,
                                    contractAdditions: arrayRemove(itemToDelete)
                                });
                                showToast('Contract addition deleted successfully!', 'success');
                            }
                        }
                        setShowDeleteConfirm(false);
                        setItemToDelete(null);
                        setDeleteType('');
                    } catch (err) {
                        console.error(`Error deleting ${deleteType}:`, err);
                        showToast(`Failed to delete ${deleteType}.`, 'error');
                    }
                };

                const cancelDelete = () => {
                    setShowDeleteConfirm(false);
                    setItemToDelete(null);
                    setDeleteType('');
                };


                const handleAddExpense = async (expenseData) => {
                    if (!db || !userId || !projectId) return;
                    try {
                        const projectDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/projects`, projectId);
                        await updateDoc(projectDocRef, {
                            expenses: arrayUnion(expenseData)
                        });
                        setShowAddExpenseModal(false);
                        showToast('Expense added successfully!', 'success');
                    } catch (err) {
                        console.error("Error adding expense:", err);
                        showToast('Failed to add expense.', 'error');
                    }
                };

                const handleAddAdditional = async (additionalData) => {
                    if (!db || !userId || !projectId) return;
                    try {
                        const projectDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/projects`, projectId);
                        const currentProjectSnap = await getDoc(projectDocRef);
                        if (currentProjectSnap.exists()) {
                            const currentProject = currentProjectSnap.data();
                            const newContractAmount = (currentProject.contractAmount || 0) + additionalData.amount;
                            await updateDoc(projectDocRef, {
                                contractAmount: newContractAmount,
                                contractAdditions: arrayUnion(additionalData)
                            });
                        }
                        setShowAddAdditionalModal(false);
                        showToast('Contract addition added successfully!', 'success');
                    } catch (err) {
                        console.error("Error adding additional to contract:", err);
                        showToast('Failed to add contract addition.', 'error');
                    }
                };


                if (loading) return <div className="text-center py-8">Loading project details...</div>;
                if (error) return <div className="text-center py-8 text-red-600">{error}</div>;
                if (!project) return <div className="text-center py-8 text-gray-600">Project data not available.</div>;

                const totalPaid = project.payments ? project.payments.reduce((sum, payment) => sum + payment.amount, 0) : 0;
                const totalExpenses = project.expenses ? project.expenses.reduce((sum, expense) => sum + expense.amount, 0) : 0;
                const remainingBalance = project.contractAmount - totalPaid;
                const profitLoss = totalPaid - totalExpenses; // Simplified profit/loss calculation based on payments received vs. expenses

                // New granular billing logic: Recommend billing if unbilled expenses exceed a threshold
                const unbilledExpenses = totalExpenses - totalPaid;
                const minimumBillingThreshold = 10000; // Recommend billing if unbilled expenses exceed â‚±10,000

                const isBillingRecommended = unbilledExpenses > minimumBillingThreshold;

                const progressPercentage = project.contractAmount > 0 ? ((totalPaid / project.contractAmount) * 100).toFixed(2) : 0;
                const isOverExpenses = profitLoss < 0;

                return (
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <div className="flex justify-between items-center mb-6 border-b pb-3">
                            <h2 className="text-2xl font-bold text-gray-900">{project.projectName}</h2>
                            <button
                                onClick={() => setView('projects')}
                                className="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"
                            >
                                Back to Projects
                            </button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <h3 className="text-xl font-semibold mb-3 text-blue-800">Project Information</h3>
                                <p className="mb-1"><span className="font-medium">Client Name:</span> {project.clientName}</p>
                                <p className="mb-1"><span className="font-medium">Contract No.:</span> {project.contractNo}</p>
                                <p className="mb-1"><span className="font-medium">Date of Contract:</span> {project.dateOfContract}</p>
                                <p className="mb-1"><span className="font-medium">Contract Amount:</span> â‚±{project.contractAmount.toLocaleString()}</p>
                            </div>

                            <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                                <h3 className="text-xl font-semibold mb-3 text-green-800">Financial Summary</h3>
                                <p className="mb-1"><span className="font-medium">Total Paid:</span> â‚±{totalPaid.toLocaleString()}</p>
                                <p className="mb-1"><span className="font-medium">Remaining Balance:</span> â‚±{remainingBalance.toLocaleString()}</p>
                                <p className="mb-1"><span className="font-medium">Total Expenses:</span> â‚±{totalExpenses.toLocaleString()}</p>
                                <p className={`font-bold text-lg mt-2 ${isOverExpenses ? 'text-red-700' : 'text-green-700'}`}>
                                    {isOverExpenses ? 'Overexpenses: ' : 'Profit: '} â‚±{Math.abs(profitLoss).toLocaleString()}
                                </p>
                            </div>
                        </div>

                        <div className="mb-8">
                            <h3 className="text-xl font-bold mb-3 text-gray-900">Payment Progress</h3>
                            <div className="w-full bg-gray-200 rounded-full h-4 mb-2">
                                <div
                                    className="bg-blue-600 h-4 rounded-full transition-all duration-500 ease-out"
                                    style={{ width: `${progressPercentage}%` }}
                                ></div>
                            </div>
                            <p className="text-sm text-gray-700">{progressPercentage}% of contract amount paid</p>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            {/* Payments Section */}
                            <div>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold text-gray-900">Payments Received</h3>
                                    {isAdminLoggedIn && (
                                        <button
                                            onClick={() => setShowAddPaymentModal(true)}
                                            className="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                                        >
                                            Add Payment
                                        </button>
                                    )}
                                </div>
                                {project.payments && project.payments.length > 0 ? (
                                    <div className="overflow-x-auto overflow-y-auto max-h-60 rounded-lg border border-gray-200 shadow-sm">
                                        <table className="min-w-full divide-y divide-gray-200">
                                            <thead className="bg-gray-50 sticky top-0">
                                                <tr>
                                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th> {/* New column for Payment Type */}
                                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mode</th>
                                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                                                    {isAdminLoggedIn && (
                                                        <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                    )}
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white divide-y divide-gray-200">
                                                {project.payments.map((payment, index) => (
                                                    <tr key={index}>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{payment.date}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">â‚±{payment.amount.toLocaleString()}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{payment.paymentType || 'N/A'}</td> {/* Display Payment Type */}
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{payment.modeOfPayment}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                            {payment.modeOfPayment === 'Check' && `Bank: ${payment.bankName}, Check No: ${payment.checkNo}`}
                                                            {payment.modeOfPayment === 'Bank Transfer' && `Bank: ${payment.bankName}, Trans. No: ${payment.transactionNo}`}
                                                            {payment.description && (payment.modeOfPayment === 'Cash' || (!payment.bankName && !payment.checkNo && !payment.transactionNo)) ? payment.description : ` (${payment.description})`}
                                                        </td>
                                                        {isAdminLoggedIn && (
                                                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                                <button
                                                                    onClick={() => handleDeleteClick(payment, 'payment')}
                                                                    className="text-red-600 hover:text-red-900 hover:underline transition duration-150 ease-in-out"
                                                                >
                                                                    Delete
                                                                </button>
                                                            </td>
                                                        )}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                ) : (
                                    <p className="text-gray-600">No payments recorded yet.</p>
                                )}
                            </div>

                            {/* Expenses Section */}
                            <div>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold text-gray-900">Project Expenses</h3>
                                    {isAdminLoggedIn && (
                                        <button
                                            onClick={() => setShowAddExpenseModal(true)}
                                            className="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50"
                                        >
                                            Add Expense
                                        </button>
                                    )}
                                </div>
                                {project.expenses && project.expenses.length > 0 ? (
                                    <div className="overflow-x-auto overflow-y-auto max-h-60 rounded-lg border border-gray-200 shadow-sm">
                                        <table className="min-w-full divide-y divide-gray-200">
                                            <thead className="bg-gray-50 sticky top-0">
                                                <tr>
                                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th> {/* New column for Expense Type */}
                                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recipient No.</th>
                                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                                    {isAdminLoggedIn && (
                                                        <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                    )}
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white divide-y divide-gray-200">
                                                {project.expenses.map((expense, index) => (
                                                    <tr key={index}>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{expense.date}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">â‚±{expense.amount.toLocaleString()}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{expense.expenseType || 'N/A'}</td> {/* Display Expense Type */}
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{expense.deliveryRecipientNo || 'N/A'}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{expense.description}</td>
                                                        {isAdminLoggedIn && (
                                                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                                <button
                                                                    onClick={() => handleDeleteClick(expense, 'expense')}
                                                                    className="text-red-600 hover:text-red-900 hover:underline transition duration-150 ease-in-out"
                                                                >
                                                                    Delete
                                                                </button>
                                                            </td>
                                                        )}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                ) : (
                                    <p className="text-gray-600">No expenses recorded yet.</p>
                                )}
                            </div>
                        </div>

                        {/* Billing Recommendation Section */}
                        <div className="mt-8 bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <h3 className="text-xl font-bold mb-3 text-yellow-800">Billing Recommendation</h3>
                            <p className="mb-1"><span className="font-medium">Total Expenses:</span> â‚±{totalExpenses.toLocaleString()}</p>
                            <p className="mb-1"><span className="font-medium">Total Payments Received:</span> â‚±{totalPaid.toLocaleString()}</p>
                            <p className="mb-3"><span className="font-medium">Unbilled Expenses:</span> â‚±{unbilledExpenses.toLocaleString()}</p>


                            {isBillingRecommended ? (
                                <div className="p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700">
                                    <p className="font-semibold">Recommendation: Consider submitting a billing report.</p>
                                    <p className="text-sm">You have â‚±{unbilledExpenses.toLocaleString()} in unbilled expenses, exceeding the â‚±{minimumBillingThreshold.toLocaleString()} threshold.</p>
                                </div>
                            ) : (
                                <div className="p-3 bg-blue-100 border-l-4 border-blue-500 text-blue-700">
                                    <p className="font-semibold">Recommendation: No immediate billing report needed.</p>
                                    <p className="text-sm">Current unbilled expenses are â‚±{unbilledExpenses.toLocaleString()}, which is below the â‚±{minimumBillingThreshold.toLocaleString()} threshold.</p>
                                </div>
                            )}
                        </div>

                        {/* Contract Additions Section */}
                        <div className="mt-8">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-xl font-bold text-gray-900">Contract Additions</h3>
                                {isAdminLoggedIn && (
                                    <button
                                        onClick={() => setShowAddAdditionalModal(true)}
                                        className="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50"
                                    >
                                        Add Additional
                                    </button>
                                )}
                            </div>
                            {project.contractAdditions && project.contractAdditions.length > 0 ? (
                                <div className="overflow-x-auto overflow-y-auto max-h-60 rounded-lg border border-gray-200 shadow-sm">
                                    <table className="min-w-full divide-y divide-gray-200">
                                        <thead className="bg-gray-50 sticky top-0">
                                            <tr>
                                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                                {isAdminLoggedIn && (
                                                    <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                )}
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white divide-y divide-gray-200">
                                            {project.contractAdditions.map((additional, index) => (
                                                <tr key={index}>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{additional.date}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">â‚±{additional.amount.toLocaleString()}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{additional.description}</td>
                                                    {isAdminLoggedIn && (
                                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                            <button
                                                                onClick={() => handleDeleteClick(additional, 'additional')}
                                                                className="text-red-600 hover:text-red-900 hover:underline transition duration-150 ease-in-out"
                                                                >
                                                                Delete
                                                            </button>
                                                        </td>
                                                    )}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            ) : (
                                <p className="text-gray-600">No contract additions recorded yet.</p>
                            )}
                        </div>


                        {showAddPaymentModal && (
                            <AddRecordModal
                                title="Add New Payment"
                                onClose={() => setShowAddPaymentModal(false)}
                                onSave={handleAddPayment}
                                type="payment"
                            />
                        )}

                        {showAddExpenseModal && (
                            <AddRecordModal
                                title="Add New Expense"
                                onClose={() => setShowAddExpenseModal(false)}
                                onSave={handleAddExpense}
                                type="expense"
                            />
                        )}

                        {showAddAdditionalModal && (
                            <AddRecordModal
                                title="Add Contract Additional"
                                onClose={() => setShowAddAdditionalModal(false)}
                                onSave={handleAddAdditional}
                                type="additional"
                            />
                        )}

                        {showDeleteConfirm && (
                            <Modal
                                title={`Confirm Delete ${deleteType.charAt(0).toUpperCase() + deleteType.slice(1)}`}
                                message={`Are you sure you want to delete this ${deleteType} of â‚±${itemToDelete?.amount.toLocaleString()} on ${itemToDelete?.date}?`}
                                onConfirm={confirmDelete}
                                onCancel={cancelDelete}
                            />
                        )}
                    </div>
                );
            };

            const TemplateEditor = ({ setView, setGeneratedReportData, isAdminLoggedIn }) => {
                const { db, userId, isAuthReady } = useFirebase();
                const [templateData, setTemplateData] = useState({
                    companyName: '',
                    address: '',
                    email: '',
                    letterBodyParagraph: '',
                    signatoryName: '',
                    signatoryTitle: '',
                    logoUrl: '',
                    defaultProjectName: 'Sample Project',
                    defaultLocation: 'Sample Location',
                    defaultSubject: 'Sample Subject',
                    defaultPoNumber: 'PO-XXXX',
                    defaultDate: new Date().toISOString().slice(0, 10),
                    defaultAttention: 'Mr./Ms. Client Representative',
                    defaultBilledAmount: 100000,
                    defaultDescriptionOfWork: 'General electrical works',
                });
                const [loading, setLoading] = useState(true);
                const [message, setMessage] = useState({ type: '', text: '' });
                const { showToast } = useContext(ToastContext); // Use ToastContext

                useEffect(() => {
                    if (!isAuthReady || !db || !userId) return;

                    const templateDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/templates`, 'billingTemplate');
                    const fetchTemplate = async () => {
                        try {
                            const docSnap = await getDoc(templateDocRef);
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                const filteredData = { ...data };
                                delete filteredData.headerElectricalSupply;
                                delete filteredData.headerSupplyDetails;
                                delete filteredData.defaultRetention;
                                delete filteredData.defaultRecoupment;
                                delete filteredData.defaultPartialPayments;
                                setTemplateData(prev => ({ ...prev, ...filteredData }));
                            } else {
                                setTemplateData(prev => ({
                                    ...prev,
                                    companyName: "D.L.Verano's Electrical Supply and Services",
                                    // Default values for new template or if not found
                                    address: "72 BULELAK ST. MALANDAY, MARIKINA CITY",
                                    email: "dl_verano@yahoo.com",
                                    letterBodyParagraph: "We are submitting herewith a billing for the above subject for the supply of labor, materials & supervision for a partial work accomplishment computed as follows:",
                                    signatoryName: "ENGR. DANTE L. VERANO",
                                    signatoryTitle: "General Manager",
                                    logoUrl: "https://storage.googleapis.com/bard-files/uploaded:DLVESS_LOGO-removebg-preview.png-06d07e7a-8081-4933-9d15-f0d91ff24150",
                                }));
                            }
                        } catch (err) {
                            console.error("Error fetching template:", err);
                            setMessage({ type: 'error', text: 'Failed to load template.' });
                            showToast('Failed to load template.', 'error');
                        } finally {
                            setLoading(false);
                        }
                    };

                    fetchTemplate();
                }, [db, userId, isAuthReady, showToast]);

                const handleChange = (e) => {
                    const { name, value } = e.target;
                    setTemplateData(prev => ({ ...prev, [name]: value }));
                };

                const handleSave = async () => {
                    if (!db || !userId) {
                        setMessage({ type: 'error', text: 'Firebase not initialized. Cannot save.' });
                        showToast('Firebase not initialized. Cannot save.', 'error');
                        return;
                    }
                    try {
                        const templateDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/templates`, 'billingTemplate');
                        const dataToSave = { ...templateData };
                        // Remove default preview fields before saving to Firebase
                        delete dataToSave.defaultProjectName;
                        delete dataToSave.defaultLocation;
                        delete dataToSave.defaultSubject;
                        delete dataToSave.defaultPoNumber;
                        delete dataToSave.defaultDate;
                        delete dataToSave.defaultAttention;
                        delete dataToSave.defaultBilledAmount;
                        delete dataToSave.defaultDescriptionOfWork;
                        delete dataToSave.headerElectricalSupply;
                        delete dataToSave.headerSupplyDetails;
                        delete dataToSave.defaultRetention;
                        delete dataToSave.defaultRecoupment;
                        delete dataToSave.defaultPartialPayments;


                        await setDoc(templateDocRef, dataToSave, { merge: true });
                        setMessage({ type: 'success', text: 'Template saved successfully!' });
                        showToast('Template saved successfully!', 'success');
                    } catch (err) {
                            console.error("Error saving template:", err);
                            setMessage({ type: 'error', text: 'Failed to save template.' });
                            showToast('Failed to save template.', 'error');
                    }
                };

                const handlePreview = () => {
                    const mockReportData = {
                        project: {
                            projectName: templateData.defaultProjectName,
                            clientName: templateData.defaultAttention,
                            contractAmount: templateData.defaultBilledAmount,
                        },
                        reportDetails: {
                            location: templateData.defaultLocation,
                            subject: templateData.defaultSubject,
                            poNumber: templateData.defaultPoNumber,
                            date: templateData.defaultDate,
                            attention: templateData.defaultAttention,
                            descriptionOfWork: templateData.defaultDescriptionOfWork,
                            netCollectibles: templateData.defaultBilledAmount,
                        },
                        billedAmount: templateData.defaultBilledAmount,
                        lessRetentionAmount: 0,
                        totalPartialPayments: 0,
                        recoupmentAmount: 0,
                        netCollectibles: templateData.defaultBilledAmount,
                        partialPaymentsList: [],
                        ownerName: templateData.defaultAttention,
                        workAccomplishmentPercentage: 100,
                        recoupmentFromDownpayment: 0,
                    };
                    setGeneratedReportData(mockReportData);
                    setView('viewReport');
                };

                if (loading) {
                    return (
                        <div className="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto text-center py-10">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto mb-4"></div>
                            <p>Loading template editor...</p>
                        </div>
                    );
                }

                if (!isAdminLoggedIn) {
                    return (
                        <div className="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto text-center py-10">
                            <h2 className="text-2xl font-bold mb-4 text-gray-900">Access Denied</h2>
                            <p className="text-gray-600">You need admin privileges to access the Template Editor.</p>
                        </div>
                    );
                }

                return (
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <h2 className="text-2xl font-bold mb-6 text-gray-900 border-b pb-3">Billing Report Template Editor</h2>

                        {message.text && (
                            <div className={`p-3 mb-4 rounded-md text-sm ${message.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                {message.text}
                            </div>
                        )}

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            {/* Company Header Fields */}
                            <div className="md:col-span-2">
                                <label htmlFor="logoUrl" className="block text-sm font-medium text-gray-700 mb-1">Company Logo URL</label>
                                <input type="text" id="logoUrl" name="logoUrl" value={templateData.logoUrl} onChange={handleChange} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., https://example.com/logo.png" />
                                {templateData.logoUrl && (
                                    <div className="mt-2 p-2 border border-gray-200 rounded-md bg-gray-50 flex items-center justify-center">
                                        <img src={templateData.logoUrl} alt="Logo Preview" className="max-h-24 object-contain" onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/100x50/cccccc/ffffff?text=Image+Error'; }} />
                                    </div>
                                )}
                            </div>
                            <div>
                                <label htmlFor="companyName" className="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
                                <input type="text" id="companyName" name="companyName" value={templateData.companyName} onChange={handleChange} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            </div>
                            <div>
                                <label htmlFor="address" className="block text-sm font-medium text-gray-700 mb-1">Address</label>
                                <input type="text" id="address" name="address" value={templateData.address} onChange={handleChange} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            </div>
                            <div>
                                <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="email" name="email" value={templateData.email} onChange={handleChange} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            </div>

                            {/* Letter Body Fields - These are for default/preview purposes in the template editor */}
                            <h3 className="col-span-full text-lg font-semibold mt-4 mb-2 text-gray-800">Default/Preview Fields for Letter Body</h3>
                            <div>
                                <label htmlFor="defaultProjectName" className="block text-sm font-medium text-gray-700 mb-1">Default Project Name</label>
                                <input type="text" id="defaultProjectName" name="defaultProjectName" value={templateData.defaultProjectName} onChange={handleChange} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            </div>
                            <div>
                                <label htmlFor="defaultLocation" className="block text-sm font-medium text-gray-700 mb-1">Default Location</label>
                                <input type="text" id="defaultLocation" name="defaultLocation" value={templateData.defaultLocation} onChange={handleChange} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            </div>
                            <div>
                                <label htmlFor="defaultSubject" className="block text-sm font-medium text-gray-700 mb-1">Default Subject</label>
                                <input type="text" id="defaultSubject" name="defaultSubject" value={templateData.defaultSubject} onChange={handleChange} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            </div>
                            <div>
                                <label htmlFor="defaultDate" className="block text-sm font-medium text-gray-700 mb-1">Default Date</label>
                                <input type="date" id="defaultDate" name="defaultDate" value={templateData.defaultDate} onChange={handleChange} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            </div>
                            <div>
                                <label htmlFor="defaultAttention" className="block text-sm font-medium text-gray-700 mb-1">Default Attention</label>
                                <input type="text" id="defaultAttention" name="defaultAttention" value={templateData.defaultAttention} onChange={handleChange} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            </div>
                            <div className="col-span-1 md:col-span-2">
                                <label htmlFor="letterBodyParagraph" className="block text-sm font-medium text-gray-700 mb-1">Letter Body Paragraph</label>
                                <textarea id="letterBodyParagraph" name="letterBodyParagraph" value={templateData.letterBodyParagraph} onChange={handleChange} rows="4" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                            </div>
                            <div>
                                <label htmlFor="defaultBilledAmount" className="block text-sm font-medium text-gray-700 mb-1">Default Billed Amount (for preview)</label>
                                <input type="number" id="defaultBilledAmount" name="defaultBilledAmount" value={templateData.defaultBilledAmount} onChange={handleChange} step="0.01" min="0" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            </div>
                            <div>
                                <label htmlFor="defaultDescriptionOfWork" className="block text-sm font-medium text-gray-700 mb-1">Default Description of Work (for preview)</label>
                                <input type="text" id="defaultDescriptionOfWork" name="defaultDescriptionOfWork" value={templateData.defaultDescriptionOfWork} onChange={handleChange} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            </div>


                            {/* Signature Fields */}
                            <h3 className="col-span-full text-lg font-semibold mt-4 mb-2 text-gray-800">Signature Details</h3>
                            <div>
                                <label htmlFor="signatoryName" className="block text-sm font-medium text-gray-700 mb-1">Signatory Name</label>
                                <input type="text" id="signatoryName" name="signatoryName" value={templateData.signatoryName} onChange={handleChange} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            </div>
                            <div>
                                <label htmlFor="signatoryTitle" className="block text-sm font-medium text-gray-700 mb-1">Signatory Title</label>
                                <input type="text" id="signatoryTitle" name="signatoryTitle" value={templateData.signatoryTitle} onChange={handleChange} className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            </div>
                        </div>

                        <div className="flex justify-end space-x-3 mt-6">
                            <button
                                type="button"
                                onClick={() => setView('dashboard')}
                                className="px-5 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"
                            >
                                Back to Dashboard
                            </button>
                            <button
                                type="button"
                                onClick={handleSave}
                                className="px-5 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                            >
                                Save Template
                            </button>
                            <button
                                type="button"
                                onClick={handlePreview}
                                className="px-5 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50"
                            >
                                Preview Template
                            </button>
                        </div>
                    </div>
                );
            };


            const BillingReportDisplay = ({ reportData, setView, setGeneratedReportData }) => {
                const { db, userId, isAuthReady } = useFirebase();
                const [template, setTemplate] = useState(null);
                const [loadingTemplate, setLoadingTemplate] = useState(true);
                const [isEditing, setIsEditing] = useState(false);
                const [editableReportData, setEditableReportData] = useState(reportData);
                const { showToast } = useContext(ToastContext); // Use ToastContext

                useEffect(() => {
                    if (!isAuthReady || !db || !userId) return;

                    const templateDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/templates`, 'billingTemplate');
                    const fetchTemplate = async () => {
                        try {
                            const docSnap = await getDoc(templateDocRef);
                            if (docSnap.exists()) {
                                setTemplate(docSnap.data());
                            } else {
                                // Fallback to default if no template saved
                                setTemplate({
                                    companyName: "D.L.Verano's Electrical Supply and Services",
                                    address: "72 BULELAK ST. MALANDAY, MARIKINA CITY",
                                    email: "dl_verano@yahoo.com",
                                    letterBodyParagraph: "We are submitting herewith a billing for the above subject for the supply of labor, materials & supervision for a partial work accomplishment computed as follows:",
                                    signatoryName: "ENGR. DANTE L. VERANO",
                                    signatoryTitle: "General Manager",
                                    logoUrl: "https://storage.googleapis.com/bard-files/uploaded:DLVESS_LOGO-removebg-preview.png-06d07e7a-8081-4933-9d15-f0d91ff24150", // Default logo
                                });
                            }
                        } catch (err) {
                            console.error("Error fetching template for display:", err);
                            showToast('Failed to load template for report display.', 'error');
                            // Continue with default template if error occurs
                            setTemplate({
                                companyName: "D.L.Verano's Electrical Supply and Services",
                                address: "72 BULELAK ST. MALANDAY, MARIKINA CITY",
                                email: "dl_verano@yahoo.com",
                                letterBodyParagraph: "We are submitting herewith a billing for the above subject for the supply of labor, materials & supervision for a partial work accomplishment computed as follows:",
                                signatoryName: "ENGR. DANTE L. VERANO",
                                signatoryTitle: "General Manager",
                                logoUrl: "https://storage.googleapis.com/bard-files/uploaded:DLVESS_LOGO-removebg-preview.png-06d07e7a-8081-4933-9d15-f0d91ff24150", // Default logo
                            });
                        } finally {
                            setLoadingTemplate(false);
                        }
                    };

                    fetchTemplate();
                }, [db, userId, isAuthReady, showToast]);

                useEffect(() => {
                    // Update editableReportData when reportData prop changes (e.g., when a new report is generated)
                    setEditableReportData(reportData);
                }, [reportData]);


                if (loadingTemplate) {
                    return <div className="text-center py-8">Loading report template...</div>;
                }

                const handleFieldChange = (e) => {
                    const { name, value } = e.target;
                    if (name.startsWith('reportDetails.')) {
                        const field = name.split('.')[1];
                        setEditableReportData(prev => ({
                            ...prev,
                            reportDetails: {
                                ...prev.reportDetails,
                                [field]: value
                            }
                        }));
                    } else if (name === 'billedAmount' || name === 'lessRetentionAmount' || name === 'recoupmentAmount' || name === 'totalPartialPayments' || name === 'netCollectibles' || name === 'recoupmentFromDownpayment' || name === 'workAccomplishmentPercentage') {
                        setEditableReportData(prev => ({
                            ...prev,
                            [name]: parseFloat(value) || 0 // Ensure numerical fields are parsed
                        }));
                    } else if (name.startsWith('project.')) {
                        const field = name.split('.')[1];
                        setEditableReportData(prev => ({
                            ...prev,
                            project: {
                                ...prev.project,
                                [field]: value
                            }
                        }));
                    } else if (name === 'ownerName') {
                        setEditableReportData(prev => ({
                            ...prev,
                            ownerName: value
                        }));
                    } else if (name.startsWith('partialPaymentsList')) {
                        const [_, index, field] = name.split('.');
                        const newPartialPaymentsList = [...editableReportData.partialPaymentsList];
                        newPartialPaymentsList[parseInt(index)] = {
                            ...newPartialPaymentsList[parseInt(index)],
                            [field]: field === 'amount' ? parseFloat(value) || 0 : value
                        };
                        setEditableReportData(prev => ({
                            ...prev,
                            partialPaymentsList: newPartialPaymentsList,
                            totalPartialPayments: newPartialPaymentsList.reduce((sum, p) => sum + p.amount, 0)
                        }));
                    }
                };

                const handleSaveEdits = () => {
                    // Update the parent state with the edited data
                    setGeneratedReportData(editableReportData);
                    setIsEditing(false);
                    showToast('Report changes saved!', 'success');
                };

                const handleCancelEdits = () => {
                    // Revert to the original reportData
                    setEditableReportData(reportData);
                    setIsEditing(false);
                    showToast('Report edits cancelled.', 'error');
                };

                const handlePrintAndSave = () => {
                    handleSaveEdits(); // Save changes first
                    console.log("Attempting to print report...");
                    // Give a small delay for state update to propagate before printing
                    setTimeout(() => {
                        window.print();
                    }, 100);
                };

                const handleBackToForm = () => {
                    setGeneratedReportData(editableReportData); // Pass current edited data back to the form
                    setView('createBilling');
                };

                // Values for computation display
                const contractAmountForDisplay = editableReportData?.project?.contractAmount;
                const workAccomplishmentPercentageForDisplay = editableReportData?.workAccomplishmentPercentage || 0;
                const recoupmentFromDownpaymentForDisplay = editableReportData?.recoupmentFromDownpayment || 0;

                // Ensure all displayed amounts are derived from editableReportData
                const billedAmount = editableReportData?.billedAmount !== undefined ? editableReportData.billedAmount : 0;
                const lessRetentionAmount = editableReportData?.lessRetentionAmount !== undefined ? editableReportData.lessRetentionAmount : 0;
                const recoupmentAmount = editableReportData?.recoupmentAmount !== undefined ? editableReportData.recoupmentAmount : 0;
                const totalPartialPayments = editableReportData?.totalPartialPayments !== undefined ? editableReportData.totalPartialPayments : 0;
                const netCollectibles = billedAmount - lessRetentionAmount - recoupmentAmount - totalPartialPayments;
                const partialPaymentsList = editableReportData?.partialPaymentsList || [];


                return (
                    <div className="bg-white p-8 rounded-lg shadow-md max-w-4xl mx-auto my-8 print:shadow-none print:p-0">
                        {/* Report Header */}
                        <div className="text-center mb-10 pb-4 relative">
                            {/* Logo added here */}
                            {template?.logoUrl && (
                                <img
                                    src={template.logoUrl}
                                    alt="Company Logo"
                                    className="absolute top-6 left-6 max-h-24 object-contain"
                                    onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/100x50/cccccc/ffffff?text=Image+Error'; }}
                                />
                            )}
                            <div className="pl-32">
                                <h1 className="text-4xl font-extrabold text-blue-800 mb-1">{template?.companyName}</h1>
                                <p className="text-base text-gray-700 mb-1">{template?.address}</p>
                                <p className="text-base text-gray-700">E-Mail Address: {template?.email}</p>
                            </div>
                        </div>

                        {/* Project and Billing Details */}
                        <div className="mb-8 text-lg">
                            <div className="grid grid-cols-2 gap-x-4 gap-y-2 mb-6">
                                <p>
                                    <span className="font-semibold w-24 inline-block">Project</span> :
                                    {isEditing ? (
                                        <input
                                            type="text"
                                            name="project.projectName"
                                            value={editableReportData?.project?.projectName || ''}
                                            onChange={handleFieldChange}
                                            className="border rounded px-2 py-1 w-48"
                                        />
                                    ) : (
                                        editableReportData?.project?.projectName
                                    )}
                                </p>
                                <p>
                                    <span className="font-semibold w-24 inline-block">Location</span> :
                                    {isEditing ? (
                                        <input
                                            type="text"
                                            name="reportDetails.location"
                                            value={editableReportData?.reportDetails?.location || ''}
                                            onChange={handleFieldChange}
                                            className="border rounded px-2 py-1 w-48"
                                        />
                                    ) : (
                                        editableReportData?.reportDetails?.location
                                    )}
                                </p>
                                <p>
                                    <span className="font-semibold w-24 inline-block">Owner</span> :
                                    {isEditing ? (
                                        <input
                                            type="text"
                                            name="ownerName"
                                            value={editableReportData?.ownerName || ''}
                                            onChange={handleFieldChange}
                                            className="border rounded px-2 py-1 w-48"
                                        />
                                    ) : (
                                        editableReportData?.ownerName
                                    )}
                                </p>
                                <p>
                                    <span className="font-semibold w-24 inline-block">Subject</span> :
                                    {isEditing ? (
                                        <input
                                            type="text"
                                            name="reportDetails.subject"
                                            value={editableReportData?.reportDetails?.subject || ''}
                                            onChange={handleFieldChange}
                                            className="border rounded px-2 py-1 w-48"
                                        />
                                    ) : (
                                        editableReportData?.reportDetails?.subject
                                    )}
                                </p>
                                <p>
                                    <span className="font-semibold w-24 inline-block">P.O. #</span> :
                                    {isEditing ? (
                                        <input
                                            type="text"
                                            name="reportDetails.poNumber"
                                            value={editableReportData?.reportDetails?.poNumber || ''}
                                            onChange={handleFieldChange}
                                            className="border rounded px-2 py-1 w-48"
                                        />
                                    ) : (
                                        editableReportData?.reportDetails?.poNumber
                                    )}
                                </p>
                                <p>
                                    <span className="font-semibold w-24 inline-block">Date</span> :
                                    {isEditing ? (
                                        <input
                                            type="date"
                                            name="reportDetails.date"
                                            value={editableReportData?.reportDetails?.date || ''}
                                            onChange={handleFieldChange}
                                            className="border rounded px-2 py-1 w-48"
                                        />
                                    ) : (
                                        editableReportData?.reportDetails?.date
                                    )}
                                </p>
                            </div>
                            <p className="mb-6">
                                <span className="font-semibold">Attention</span> :
                                {isEditing ? (
                                    <input
                                        type="text"
                                        name="reportDetails.attention"
                                        value={editableReportData?.reportDetails?.attention || ''}
                                        onChange={handleFieldChange}
                                        className="border rounded px-2 py-1 w-96"
                                    />
                                ) : (
                                    editableReportData?.reportDetails?.attention
                                )}
                            </p>
                            <p className="mb-6">Sir,</p>
                            <p className="mb-6 indent-8 text-justify">
                                {template?.letterBodyParagraph}
                            </p>

                            {/* Billing Breakdown */}
                            <div className="mb-8 border-t border-gray-300 pt-6">
                                <div className="flex justify-between items-center mb-2">
                                    <p className="font-semibold">Contract Amount:</p>
                                    <p className="font-bold text-xl">â‚±{contractAmountForDisplay.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                                </div>
                                <div className="flex justify-between items-center mb-2">
                                    <p className="font-semibold">
                                        Billed Amount (Contract x
                                        {isEditing ? (
                                            <input
                                                type="number"
                                                name="workAccomplishmentPercentage"
                                                value={editableReportData?.workAccomplishmentPercentage || 0}
                                                onChange={handleFieldChange}
                                                className="border rounded px-1 py-0.5 w-16 text-right"
                                                step="0.01"
                                            />
                                        ) : (
                                            workAccomplishmentPercentageForDisplay
                                        )}
                                        %):
                                    </p>
                                    <p className="font-bold text-xl">
                                        {isEditing ? (
                                            <input
                                                type="number"
                                                name="billedAmount"
                                                value={billedAmount}
                                                onChange={handleFieldChange}
                                                className="border rounded px-2 py-1 w-32 text-right"
                                                step="0.01"
                                            />
                                        ) : (
                                            `â‚±${billedAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                                        )}
                                    </p>
                                </div>
                                <div className="flex justify-between items-center mb-2">
                                    <p className="font-semibold">
                                        Less: Retention (
                                        {isEditing ? (
                                            <input
                                                type="number"
                                                name="lessRetentionAmount"
                                                value={lessRetentionAmount}
                                                onChange={handleFieldChange}
                                                className="border rounded px-2 py-1 w-32 text-right"
                                                step="0.01"
                                            />
                                        ) : (
                                            `â‚±${lessRetentionAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                                        )}
                                        ):
                                    </p>
                                    <p className="font-bold text-xl">
                                        {isEditing ? (
                                            <input
                                                type="number"
                                                name="lessRetentionAmount"
                                                value={lessRetentionAmount}
                                                onChange={handleFieldChange}
                                                className="border rounded px-2 py-1 w-32 text-right"
                                                step="0.01"
                                            />
                                        ) : (
                                            `- â‚±${lessRetentionAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                                        )}
                                    </p>
                                </div>
                                {/* New Recoupment from D/P line item with computation */}
                                <div className="flex justify-between items-center mb-2">
                                    <p className="font-semibold">
                                        Less: Recoupment from D/P (â‚±
                                        {isEditing ? (
                                            <input
                                                type="number"
                                                name="recoupmentFromDownpayment"
                                                value={recoupmentFromDownpaymentForDisplay}
                                                onChange={handleFieldChange}
                                                className="border rounded px-1 py-0.5 w-24 text-right"
                                                step="0.01"
                                            />
                                        ) : (
                                            recoupmentFromDownpaymentForDisplay.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                                        )}
                                        x {workAccomplishmentPercentageForDisplay}%):
                                    </p>
                                    <p className="font-bold text-xl">
                                        {isEditing ? (
                                            <input
                                                type="number"
                                                name="recoupmentAmount"
                                                value={recoupmentAmount}
                                                onChange={handleFieldChange}
                                                className="border rounded px-2 py-1 w-32 text-right"
                                                step="0.01"
                                            />
                                        ) : (
                                            `- â‚±${recoupmentAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                                        )}
                                    </p>
                                </div>
                                {partialPaymentsList.length > 0 && (
                                    <div>
                                        <p className="font-semibold mt-4 mb-2">Partial Payments:</p>
                                        {partialPaymentsList.map((payment, index) => (
                                            <div key={index} className="flex justify-between items-center mb-1 ml-4">
                                                <p className="text-sm text-gray-700">
                                                    {isEditing ? (
                                                        <input
                                                            type="text"
                                                            name={`partialPaymentsList.${index}.description`}
                                                            value={payment.description || ''}
                                                            onChange={handleFieldChange}
                                                            className="border rounded px-1 py-0.5 w-48"
                                                        />
                                                    ) : (
                                                        payment.description || `Payment ${index + 1}`
                                                    )}
                                                    ({payment.date}):
                                                </p>
                                                <p className="text-sm font-semibold">
                                                    - â‚±
                                                    {isEditing ? (
                                                        <input
                                                            type="number"
                                                            name={`partialPaymentsList.${index}.amount`}
                                                            value={payment.amount}
                                                            onChange={handleFieldChange}
                                                            className="border rounded px-1 py-0.5 w-24 text-right"
                                                            step="0.01"
                                                        />
                                                    ) : (
                                                        payment.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                                                    )}
                                                </p>
                                            </div>
                                        ))}
                                        <div className="flex justify-between items-center mt-2 border-t border-gray-200 pt-2">
                                            <p className="font-semibold">Total Partial Payments:</p>
                                            <p className="font-bold text-lg">
                                                {isEditing ? (
                                                    <input
                                                        type="number"
                                                        name="totalPartialPayments"
                                                        value={totalPartialPayments}
                                                        onChange={handleFieldChange}
                                                        className="border rounded px-2 py-1 w-32 text-right"
                                                        step="0.01"
                                                    />
                                                ) : (
                                                    `- â‚±${totalPartialPayments.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                                                )}
                                            </p>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Net Collectibles */}
                            <div className="flex justify-end items-center mb-12 border-t-2 border-b-2 border-gray-900 py-2">
                                <span className="text-xl font-bold mr-4">NET COLLECTIBLES:</span>
                                <span className="text-2xl font-extrabold text-blue-800">
                                    {isEditing ? (
                                        <input
                                            type="number"
                                            name="netCollectibles"
                                            value={netCollectibles}
                                            onChange={handleFieldChange}
                                            className="border rounded px-2 py-1 w-40 text-right"
                                            step="0.01"
                                        />
                                    ) : (
                                        `â‚±${netCollectibles.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                                    )}
                                </span>
                            </div>
                        </div>

                        {/* Signature Area */}
                        <div className="text-right mt-16 flex flex-col items-end">
                            <p className="mb-10">Very truly yours;</p>
                            <div className="border-b border-gray-700 w-72 mb-2"></div>
                            <p className="font-semibold text-xl">{template?.signatoryName}</p>
                            <p className="text-base text-gray-700">{template?.signatoryTitle}</p>
                        </div>

                        {/* Control Buttons */}
                        <div className="mt-12 text-center print:hidden">
                            {!isEditing ? (
                                <>
                                    <button
                                        onClick={() => setIsEditing(true)}
                                        className="px-6 py-3 rounded-lg bg-yellow-600 text-white hover:bg-yellow-700 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-50 mr-4"
                                    >
                                        Edit Report
                                    </button>
                                    <button
                                        onClick={handleBackToForm}
                                        className="px-6 py-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 mr-4"
                                    >
                                        Back to Report Form
                                    </button>
                                    <button
                                        onClick={() => { console.log("Attempting to print report..."); window.print(); }}
                                        className="px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                                    >
                                        Print Report
                                    </button>
                                </>
                            ) : (
                                <>
                                    <button
                                        onClick={handleSaveEdits}
                                        className="px-6 py-3 rounded-lg bg-green-600 text-white hover:bg-green-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 mr-4"
                                    >
                                        Save Changes
                                    </button>
                                    <button
                                        onClick={handleCancelEdits}
                                        className="px-6 py-3 rounded-lg bg-red-600 text-white hover:bg-red-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 mr-4"
                                    >
                                        Cancel Edit
                                    </button>
                                    <button
                                        onClick={handlePrintAndSave}
                                        className="px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                                    >
                                        Save & Print
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                );
            };


            const CreateBillingForm = ({ setView, setGeneratedReportData, initialReportData, isAdminLoggedIn }) => {
                const { db, userId, isAuthReady } = useFirebase();
                const [projects, setProjects] = useState([]);
                const [selectedProjectId, setSelectedProjectId] = useState(initialReportData?.project?.id || '');
                const [selectedProject, setSelectedProject] = useState(null);
                const [contractAmount, setContractAmount] = useState(initialReportData?.project?.contractAmount || 0);
                const [workAccomplishmentPercentage, setWorkAccomplishmentPercentage] = useState(initialReportData?.workAccomplishmentPercentage?.toString() || '');
                const [retentionPercentage, setRetentionPercentage] = useState(initialReportData?.reportDetails?.retentionPercentage?.toString() || ''); // Assuming retention percentage might be stored here or derived
                const [recoupmentFromDownpayment, setRecoupmentFromDownpayment] = useState(initialReportData?.recoupmentFromDownpayment?.toString() || '');
                const [projectPayments, setProjectPayments] = useState([]);
                const [selectedPartialPayments, setSelectedPartialPayments] = useState(initialReportData?.partialPaymentsList || []);
                const [errors, setErrors] = useState({});
                const [message, setMessage] = useState({ type: '', text: '' });
                const { showToast } = useContext(ToastContext); // Use ToastContext

                // Calculated values (re-calculate based on current form state)
                const billedAmount = selectedProject && workAccomplishmentPercentage !== ''
                    ? (contractAmount * (parseFloat(workAccomplishmentPercentage) / 100))
                    : 0;

                const lessRetentionAmount = retentionPercentage !== ''
                    ? (billedAmount * (parseFloat(retentionPercentage) / 100))
                    : 0;

                const recoupmentAmount = recoupmentFromDownpayment !== '' && workAccomplishmentPercentage !== ''
                    ? (parseFloat(recoupmentFromDownpayment) * (parseFloat(workAccomplishmentPercentage) / 100))
                    : 0;

                const totalSelectedPartialPayments = selectedPartialPayments.reduce((sum, payment) => sum + payment.amount, 0);

                const netCollectibles = billedAmount - lessRetentionAmount - recoupmentAmount - totalSelectedPartialPayments;

                useEffect(() => {
                    if (!isAuthReady || !db || !userId) return;

                    const projectsColRef = collection(db, `artifacts/${__app_id}/users/${userId}/projects`);
                    const unsubscribe = onSnapshot(projectsColRef, (snapshot) => {
                        const projectsData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setProjects(projectsData);

                        // If initialReportData is provided, find and set the selected project
                        if (initialReportData && initialReportData.project && projectsData.length > 0) {
                            const preSelectedProject = projectsData.find(p => p.id === initialReportData.project.id);
                            if (preSelectedProject) {
                                setSelectedProject(preSelectedProject);
                                setContractAmount(preSelectedProject.contractAmount);

                                // Re-filter payments based on the pre-selected project
                                const filteredPayments = preSelectedProject.payments
                                    ? preSelectedProject.payments.filter(p => p.paymentType !== 'Downpayment')
                                    : [];
                                setProjectPayments(filteredPayments);
                            }
                        }
                    }, (err) => {
                        console.error("Error fetching projects for billing form:", err);
                        setMessage({ type: 'error', text: 'Failed to load projects.' });
                        showToast('Failed to load projects for billing form.', 'error');
                    });

                    return () => unsubscribe();
                }, [db, userId, isAuthReady, initialReportData, showToast]);


                const handleProjectChange = (e) => {
                    const projectId = e.target.value;
                    const project = projects.find(p => p.id === projectId);
                    setSelectedProjectId(projectId);
                    setSelectedProject(project);
                    setContractAmount(project ? project.contractAmount : 0);
                    setWorkAccomplishmentPercentage('');
                    setRetentionPercentage('');

                    const totalDownpayment = project && project.payments
                        ? project.payments.filter(p => p.paymentType === 'Downpayment').reduce((sum, p) => sum + p.amount, 0)
                        : 0;
                    setRecoupmentFromDownpayment(totalDownpayment.toFixed(2));

                    const filteredPayments = project && project.payments
                        ? project.payments.filter(p => p.paymentType !== 'Downpayment')
                        : [];
                    setProjectPayments(filteredPayments);
                    setSelectedPartialPayments([]);
                    setErrors({});
                    setMessage({ type: '', text: '' });
                };

                const handlePartialPaymentSelection = (payment, isChecked) => {
                    if (isChecked) {
                        setSelectedPartialPayments(prev => [...prev, payment]);
                    } else {
                        setSelectedPartialPayments(prev => prev.filter(p => p.date !== payment.date || p.amount !== payment.amount || p.description !== payment.description)); // More robust check
                    }
                };


                const handleGenerateReport = () => {
                    if (!selectedProject) {
                        setMessage({ type: 'error', text: 'Please select a project.' });
                        showToast('Please select a project.', 'error');
                        return;
                    }
                    if (workAccomplishmentPercentage === '' || isNaN(parseFloat(workAccomplishmentPercentage)) || parseFloat(workAccomplishmentPercentage) < 0) {
                        setMessage({ type: 'error', text: 'Please enter a valid Work Accomplishment Percentage.' });
                        showToast('Please enter a valid Work Accomplishment Percentage.', 'error');
                        return;
                    }
                    if (retentionPercentage === '' || isNaN(parseFloat(retentionPercentage)) || parseFloat(retentionPercentage) < 0) {
                        setMessage({ type: 'error', text: 'Please enter a valid Retention Percentage.' });
                        showToast('Please enter a valid Retention Percentage.', 'error');
                        return;
                    }
                    if (recoupmentFromDownpayment !== '' && (isNaN(parseFloat(recoupmentFromDownpayment)) || parseFloat(recoupmentFromDownpayment) < 0)) {
                        setMessage({ type: 'error', text: 'Please enter a valid Recoupment from Downpayment amount.' });
                        showToast('Please enter a valid Recoupment from Downpayment amount.', 'error');
                        return;
                    }


                    const reportDetails = {
                        location: selectedProject.location || 'N/A',
                        subject: `Billing for ${selectedProject.projectName}`,
                        poNumber: selectedProject.contractNo || 'N/A',
                        date: new Date().toISOString().slice(0, 10),
                        attention: selectedProject.clientName,
                        descriptionOfWork: `Partial work accomplishment of ${workAccomplishmentPercentage}% for ${selectedProject.projectName}`,
                        billedAmount: billedAmount,
                        lessRetentionAmount: lessRetentionAmount,
                        recoupmentAmount: recoupmentAmount,
                        totalPartialPayments: totalSelectedPartialPayments,
                        partialPaymentsList: selectedPartialPayments, // Pass the selected partial payments list
                    };

                    setGeneratedReportData({
                        project: selectedProject,
                        reportDetails: reportDetails,
                        billedAmount: billedAmount,
                        lessRetentionAmount: lessRetentionAmount,
                        recoupmentAmount: recoupmentAmount,
                        totalPartialPayments: totalSelectedPartialPayments,
                        netCollectibles: netCollectibles,
                        partialPaymentsList: selectedPartialPayments,
                        ownerName: selectedProject.clientName,
                        workAccomplishmentPercentage: parseFloat(workAccomplishmentPercentage),
                        recoupmentFromDownpayment: parseFloat(recoupmentFromDownpayment || 0),
                    });
                    setView('viewReport');
                    showToast('Billing report generated!', 'success');
                };

                if (!isAdminLoggedIn) {
                    return (
                        <div className="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto text-center py-10">
                            <h2 className="text-2xl font-bold mb-4 text-gray-900">Access Denied</h2>
                            <p className="text-gray-600">You need admin privileges to create billing reports.</p>
                        </div>
                    );
                }

                return (
                    <div className="bg-white p-6 rounded-lg shadow-md max-w-3xl mx-auto">
                        <h2 className="text-2xl font-bold mb-6 text-gray-900 border-b pb-3">Create Billing Report</h2>

                        {message.text && (
                            <div className={`p-3 mb-4 rounded-md text-sm ${message.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                {message.text}
                            </div>
                        )}

                        <div className="space-y-4">
                            <div>
                                <label htmlFor="projectSelect" className="block text-sm font-medium text-gray-700 mb-1">Select Project</label>
                                <select
                                    id="projectSelect"
                                    onChange={handleProjectChange}
                                    value={selectedProjectId}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                >
                                    <option value="">-- Select a Project --</option>
                                    {projects.map(project => (
                                        <option key={project.id} value={project.id}>
                                            {project.projectName} - {project.clientName}
                                        </option>
                                    ))}
                                </select>
                                {errors.projectSelect && <p className="mt-1 text-xs text-red-600">{errors.projectSelect}</p>}
                            </div>

                            <div>
                                <label htmlFor="contractAmount" className="block text-sm font-medium text-gray-700 mb-1">Contract Amount (â‚±)</label>
                                <input
                                    type="text"
                                    id="contractAmount"
                                    value={contractAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                    readOnly
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 cursor-not-allowed sm:text-sm"
                                />
                            </div>

                            <div>
                                <label htmlFor="workAccomplishmentPercentage" className="block text-sm font-medium text-gray-700 mb-1">Work Accomplishment Percentage (%)</label>
                                <input
                                    type="number"
                                    id="workAccomplishmentPercentage"
                                    value={workAccomplishmentPercentage}
                                    onChange={(e) => {
                                        setWorkAccomplishmentPercentage(e.target.value);
                                        setErrors(prev => ({ ...prev, workAccomplishmentPercentage: '' }));
                                    }}
                                    min="0"
                                    max="100"
                                    step="0.01"
                                    className={`mt-1 block w-full px-3 py-2 border ${errors.workAccomplishmentPercentage ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                                />
                                {errors.workAccomplishmentPercentage && <p className="mt-1 text-xs text-red-600">{errors.workAccomplishmentPercentage}</p>}
                            </div>

                            <div>
                                <label htmlFor="billedAmount" className="block text-sm font-medium text-gray-700 mb-1">Billed Amount (â‚±)</label>
                                <input
                                    type="text"
                                    id="billedAmount"
                                    value={billedAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                    readOnly
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 cursor-not-allowed sm:text-sm"
                                />
                            </div>

                            <div>
                                <label htmlFor="retentionPercentage" className="block text-sm font-medium text-gray-700 mb-1">Retention Percentage (%)</label>
                                <input
                                    type="number"
                                    id="retentionPercentage"
                                    value={retentionPercentage}
                                    onChange={(e) => {
                                        setRetentionPercentage(e.target.value);
                                        setErrors(prev => ({ ...prev, retentionPercentage: '' }));
                                    }}
                                    min="0"
                                    max="100"
                                    step="0.01"
                                    className={`mt-1 block w-full px-3 py-2 border ${errors.retentionPercentage ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                                />
                                {errors.retentionPercentage && <p className="mt-1 text-xs text-red-600">{errors.retentionPercentage}</p>}
                            </div>

                            <div>
                                <label htmlFor="lessRetentionAmount" className="block text-sm font-medium text-gray-700 mb-1">Less: Retention (â‚±)</label>
                                <input
                                    type="text"
                                    id="lessRetentionAmount"
                                    value={lessRetentionAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                    readOnly
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 cursor-not-allowed sm:text-sm"
                                />
                            </div>

                            {/* New Recoupment from Downpayment field */}
                            <div>
                                <label htmlFor="recoupmentFromDownpayment" className="block text-sm font-medium text-gray-700 mb-1">Recoupment from Downpayment (â‚±)</label>
                                <input
                                    type="text" // Changed to text as it's readOnly now
                                    id="recoupmentFromDownpayment"
                                    value={recoupmentFromDownpayment}
                                    readOnly // Made read-only
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 cursor-not-allowed sm:text-sm"
                                />
                            </div>

                            {/* Display calculated recoupment amount */}
                            <div>
                                <label htmlFor="calculatedRecoupmentAmount" className="block text-sm font-medium text-gray-700 mb-1">Calculated Recoupment (â‚±)</label>
                                <input
                                    type="text"
                                    id="calculatedRecoupmentAmount"
                                    value={recoupmentAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                    readOnly
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 cursor-not-allowed sm:text-sm"
                                />
                            </div>


                            {/* Partial Payments Section - Now displays fetched payments with checkboxes */}
                            <div className="border border-gray-200 p-4 rounded-md bg-gray-50">
                                <div className="flex justify-between items-center mb-3">
                                    <h3 className="text-lg font-semibold text-gray-800">Select Partial Payments for Report</h3>
                                </div>
                                {projectPayments.length === 0 ? (
                                    <p className="text-sm text-gray-600">No payments recorded for this project yet.</p>
                                ) : (
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full divide-y divide-gray-200">
                                            <thead className="bg-gray-100">
                                                <tr>
                                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Include</th>
                                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th> {/* Added Type column */}
                                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white divide-y divide-gray-200">
                                                {projectPayments.map((payment, index) => (
                                                    <tr key={index}>
                                                        <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-800">
                                                            <input
                                                                type="checkbox"
                                                                checked={selectedPartialPayments.some(p => p.date === payment.date && p.amount === payment.amount && p.description === payment.description)} // Check by unique properties
                                                                onChange={(e) => handlePartialPaymentSelection(payment, e.target.checked)}
                                                                className="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out"
                                                            />
                                                        </td>
                                                        <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-800">{payment.date}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-800">â‚±{payment.amount.toLocaleString()}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-800">{payment.paymentType || 'N/A'}</td> {/* Display payment type */}
                                                        <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-800">{payment.description}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                                <div className="flex justify-between items-center mt-4 pt-2 border-t border-gray-200">
                                    <p className="font-semibold text-gray-800">Total Selected Partial Payments:</p>
                                    <p className="font-bold text-lg text-gray-900">â‚±{totalSelectedPartialPayments.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                                </div>
                            </div>

                            {/* Net Collectibles */}
                            <div className="flex justify-between items-center bg-blue-100 p-4 rounded-md border border-blue-200">
                                <p className="text-lg font-bold text-blue-800">Net Collectibles:</p>
                                <p className="text-2xl font-extrabold text-blue-800">â‚±{netCollectibles.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                            </div>

                            <div className="flex justify-end space-x-3 mt-6">
                                <button
                                    type="button"
                                    onClick={() => setView('dashboard')}
                                    className="px-5 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="button"
                                    onClick={handleGenerateReport}
                                    className="px-5 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                                >
                                    Generate Billing Report
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            // New component for creating expense report form
            const CreateExpenseReportForm = ({ setView, setGeneratedExpenseReportData, isAdminLoggedIn }) => {
                const { db, userId, isAuthReady } = useFirebase();
                const [projects, setProjects] = useState([]);
                const [selectedProject, setSelectedProject] = useState(null);
                const [message, setMessage] = useState({ type: '', text: '' });
                const { showToast } = useContext(ToastContext); // Use ToastContext

                useEffect(() => {
                    if (!isAuthReady || !db || !userId) return;

                    const projectsColRef = collection(db, `artifacts/${__app_id}/users/${userId}/projects`);
                    const unsubscribe = onSnapshot(projectsColRef, (snapshot) => {
                        const projectsData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setProjects(projectsData);
                    }, (err) => {
                        console.error("Error fetching projects for expense report form:", err);
                        setMessage({ type: 'error', text: 'Failed to load projects.' });
                        showToast('Failed to load projects for expense report.', 'error');
                    });

                    return () => unsubscribe();
                }, [db, userId, isAuthReady, showToast]);

                const handleProjectChange = (e) => {
                    const projectId = e.target.value;
                    const project = projects.find(p => p.id === projectId);
                    setSelectedProject(project);
                    setMessage({ type: '', text: '' }); // Clear messages on project change
                };

                const handleGenerateReport = () => {
                    if (!selectedProject) {
                        setMessage({ type: 'error', text: 'Please select a project to generate an expense report.' });
                        showToast('Please select a project to generate an expense report.', 'error');
                        return;
                    }

                    // Prepare data for the expense report display
                    setGeneratedExpenseReportData({
                        project: selectedProject,
                        expenses: selectedProject.expenses || [],
                        reportDate: new Date().toISOString().slice(0, 10),
                    });
                    setView('viewExpenseReport');
                    showToast('Expense report generated!', 'success');
                };

                if (!isAdminLoggedIn) {
                    return (
                        <div className="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto text-center py-10">
                            <h2 className="text-2xl font-bold mb-4 text-gray-900">Access Denied</h2>
                            <p className="text-gray-600">You need admin privileges to create expense reports.</p>
                        </div>
                    );
                }

                return (
                    <div className="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
                        <h2 className="text-2xl font-bold mb-6 text-gray-900 border-b pb-3">Create Expenses Report</h2>

                        {message.text && (
                            <div className={`p-3 mb-4 rounded-md text-sm ${message.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                {message.text}
                            </div>
                        )}

                        <div className="space-y-4">
                            <div>
                                <label htmlFor="projectSelect" className="block text-sm font-medium text-gray-700 mb-1">Select Project</label>
                                <select
                                    id="projectSelect"
                                    onChange={handleProjectChange}
                                    value={selectedProject ? selectedProject.id : ''}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm"
                                >
                                    <option value="">-- Select a Project --</option>
                                    {projects.map(project => (
                                        <option key={project.id} value={project.id}>
                                            {project.projectName} - {project.clientName}
                                        </option>
                                    ))}
                                </select>
                            </div>

                            {selectedProject && selectedProject.expenses && selectedProject.expenses.length > 0 && (
                                <div className="mt-6">
                                    <h3 className="text-xl font-bold mb-4 text-gray-900">Expenses for {selectedProject.projectName}</h3>
                                    <div className="overflow-x-auto overflow-y-auto max-h-60 rounded-lg border border-gray-200 shadow-sm">
                                        <table className="min-w-full divide-y divide-gray-200">
                                            <thead className="bg-gray-50 sticky top-0">
                                                <tr>
                                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                                    <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white divide-y divide-gray-200">
                                                {selectedProject.expenses.map((expense, index) => (
                                                    <tr key={index}>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{expense.date}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">â‚±{expense.amount.toLocaleString()}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{expense.expenseType || 'N/A'}</td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{expense.description}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="mt-4 text-right text-lg font-semibold text-gray-800">
                                        Total Expenses: â‚±{selectedProject.expenses.reduce((sum, exp) => sum + exp.amount, 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                    </div>
                                </div>
                            )}
                            {selectedProject && (!selectedProject.expenses || selectedProject.expenses.length === 0) && (
                                <p className="text-gray-600 mt-4">No expenses recorded for this project.</p>
                            )}

                            <div className="flex justify-end space-x-3 mt-6">
                                <button
                                    type="button"
                                    onClick={() => setView('dashboard')}
                                    className="px-5 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="button"
                                    onClick={handleGenerateReport}
                                    className="px-5 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50"
                                    disabled={!selectedProject || (selectedProject.expenses && selectedProject.expenses.length === 0)}
                                >
                                    Generate Expenses Report
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            // New component for displaying the generated expense report
            const ExpenseReportDisplay = ({ reportData, setView }) => {
                const { db, userId, isAuthReady } = useFirebase();
                const [template, setTemplate] = useState(null);
                const [loadingTemplate, setLoadingTemplate] = useState(true);
                const { showToast } = useContext(ToastContext); // Use ToastContext

                useEffect(() => {
                    if (!isAuthReady || !db || !userId) return;

                    const templateDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/templates`, 'billingTemplate');
                    const fetchTemplate = async () => {
                        try {
                            const docSnap = await getDoc(templateDocRef);
                            if (docSnap.exists()) {
                                setTemplate(docSnap.data());
                            } else {
                                // Fallback to default if no template saved
                                setTemplate({
                                    companyName: "D.L.Verano's Electrical Supply and Services",
                                    address: "72 BULELAK ST. MALANDAY, MARIKINA CITY",
                                    email: "dl_verano@yahoo.com",
                                    signatoryName: "ENGR. DANTE L. VERANO",
                                    signatoryTitle: "General Manager",
                                    logoUrl: "https://storage.googleapis.com/bard-files/uploaded:DLVESS_LOGO-removebg-preview.png-06d07e7a-8081-4933-9d15-f0d91ff24150", // Default logo
                                });
                            }
                        } catch (err) {
                            console.error("Error fetching template for expense report display:", err);
                            showToast('Failed to load template for expense report display.', 'error');
                            setTemplate({
                                companyName: "D.L.Verano's Electrical Supply and Services",
                                address: "72 BULELAK ST. MALANDAY, MARIKINA CITY",
                                email: "dl_verano@yahoo.com",
                                signatoryName: "ENGR. DANTE L. VERANO",
                                signatoryTitle: "General Manager",
                                logoUrl: "https://storage.googleapis.com/bard-files/uploaded:DLVESS_LOGO-removebg-preview.png-06d07e7a-8081-4933-9d15-f0d91ff24150", // Default logo
                            });
                        } finally {
                            setLoadingTemplate(false);
                        }
                    };

                    fetchTemplate();
                }, [db, userId, isAuthReady, showToast]);

                if (loadingTemplate) {
                    return <div className="text-center py-8">Loading report template...</div>;
                }

                const { project, expenses, reportDate } = reportData;
                const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);

                // Group expenses by type for display
                const groupedExpenses = expenses.reduce((acc, expense) => {
                    const type = expense.expenseType || 'Other Expenses'; // Default to 'Other Expenses' if type is missing
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(expense);
                    return acc;
                }, {});

                // Define a preferred order for expense types
                const expenseTypesOrder = ['Material Expenses', 'Payroll Expenses', 'Other Expenses'];

                return (
                    <div className="bg-white p-8 rounded-lg shadow-md max-w-4xl mx-auto my-8 print:shadow-none print:p-0">
                        {/* Report Header */}
                        <div className="text-center mb-10 pb-4 relative">
                            {template?.logoUrl && (
                                <img
                                    src={template.logoUrl}
                                    alt="Company Logo"
                                    className="absolute top-6 left-6 max-h-24 object-contain"
                                    onError={(e) => { e.target.onerror = null; e.target.src = 'https://placehold.co/100x50/cccccc/ffffff?text=Logo+Error'; }}
                                />
                            )}
                            <div className="pl-32">
                                <h1 className="text-4xl font-extrabold text-blue-800 mb-1">{template?.companyName}</h1>
                                <p className="text-base text-gray-700 mb-1">{template?.address}</p>
                                <p className="text-base text-gray-700">E-Mail Address: {template?.email}</p>
                            </div>
                        </div>

                        {/* Report Title and Project Info */}
                        <div className="mb-8 text-lg">
                            <h2 className="text-3xl font-bold text-center mb-6 text-gray-900">Project Expenses Report</h2>
                            <div className="grid grid-cols-2 gap-x-4 gap-y-2 mb-6">
                                <p><span className="font-semibold w-24 inline-block">Project Name</span> : {project.projectName}</p>
                                <p><span className="font-semibold w-24 inline-block">Client Name</span> : {project.clientName}</p>
                                <p><span className="font-semibold w-24 inline-block">Report Date</span> : {reportDate}</p>
                            </div>
                        </div>

                        {/* Expenses Table */}
                        <div className="mb-8 border-t border-gray-300 pt-6">
                            <h3 className="text-xl font-bold mb-4 text-gray-900">Detailed Expenses</h3>
                            {expenses.length > 0 ? (
                                <div className="space-y-6">
                                    {expenseTypesOrder.map(type => {
                                        const expensesOfType = groupedExpenses[type] || [];
                                        const subtotalOfType = expensesOfType.reduce((sum, exp) => sum + exp.amount, 0);
                                        if (expensesOfType.length === 0) return null; // Don't render section if no expenses of this type

                                        return (
                                            <div key={type}>
                                                <h4 className="text-lg font-bold text-gray-800 mb-2">{type}</h4>
                                                <div className="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                                                    <table className="min-w-full divide-y divide-gray-200">
                                                        <thead className="bg-gray-50">
                                                            <tr>
                                                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recipient No.</th>
                                                                <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="bg-white divide-y divide-gray-200">
                                                            {expensesOfType.map((expense, index) => (
                                                                <tr key={index}>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{expense.date}</td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{expense.description}</td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{expense.deliveryRecipientNo || 'N/A'}</td>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">â‚±{expense.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div className="mt-2 text-right text-md font-semibold text-gray-700">
                                                    Subtotal {type}: â‚±{subtotalOfType.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            ) : (
                                <p className="text-gray-600">No expenses recorded for this project.</p>
                            )}
                        </div>

                        {/* Total Expenses */}
                        <div className="flex justify-end items-center mb-12 border-t-2 border-b-2 border-gray-900 py-2">
                            <span className="text-xl font-bold mr-4">TOTAL EXPENSES:</span>
                            <span className="text-2xl font-extrabold text-red-700">â‚±{totalExpenses.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                        </div>

                        {/* Signature Area */}
                        <div className="text-right mt-16 flex flex-col items-end">
                            <p className="mb-10">Prepared by;</p>
                            <div className="border-b border-gray-700 w-72 mb-2"></div>
                            <p className="font-semibold text-xl">{template?.signatoryName}</p>
                            <p className="text-base text-gray-700">{template?.signatoryTitle}</p>
                        </div>

                        {/* Back and Print Buttons */}
                        <div className="mt-12 text-center print:hidden">
                            <button
                                onClick={() => setView('createExpenseReport')}
                                className="px-6 py-3 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 mr-4"
                            >
                                Back to Expense Report Form
                            </button>
                            <button
                                onClick={() => { console.log("Attempting to print expense report..."); window.print(); }}
                                className="px-6 py-3 rounded-lg bg-teal-600 text-white hover:bg-teal-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50"
                            >
                                Print Report
                            </button>
                        </div>
                    </div>
                );
            };


            // --- Main App Component ---
            const App = () => {
                const [view, setView] = useState('dashboard');
                const [selectedProjectId, setSelectedProjectId] = useState(null);
                const [generatedReportData, setGeneratedReportData] = useState(null);
                const [generatedExpenseReportData, setGeneratedExpenseReportData] = useState(null); // New state for expense report
                const [firebaseApp, setFirebaseApp] = useState(null);
                const [db, setDb] = useState(null);
                const [auth, setAuth] = useState(null);
                const [userId, setUserId] = useState(null);
                const [isAuthReady, setIsAuthReady] = useState(false);
                const [loading, setLoading] = useState(true);
                const [error, setError] = useState(null);
                const [isAdminLoggedIn, setIsAdminLoggedIn] = useState(false); // New state for admin access
                const [showAdminLoginModal, setShowAdminLoginModal] = useState(false); // New state for admin login modal

                useEffect(() => {
                    const initializeFirebase = async () => {
                        try {
                            // Directly use window.firebaseConfig as it's already an object
                            const config = window.firebaseConfig;
                            const appId = window.__app_id;
                            const initialAuthToken = window.__initial_auth_token;

                            if (!config || Object.keys(config).length === 0) {
                                throw new Error("Firebase configuration is missing. Please ensure window.firebaseConfig is set.");
                            }

                            const app = initializeApp(config);
                            const firestore = getFirestore(app);
                            const authentication = getAuth(app);

                            setFirebaseApp(app);
                            setDb(firestore);
                            setAuth(authentication);

                            const unsubscribe = onAuthStateChanged(authentication, async (user) => {
                                if (user) {
                                    setUserId(user.uid);
                                } else {
                                    if (initialAuthToken) {
                                        await signInWithCustomToken(authentication, initialAuthToken);
                                    } else {
                                        await signInAnonymously(authentication);
                                    }
                                }
                                setIsAuthReady(true);
                                setLoading(false);
                            });

                            return () => unsubscribe();
                        } catch (err) {
                            console.error("Failed to initialize Firebase:", err);
                            setError("Failed to initialize Firebase. Please check console for details.");
                            setLoading(false);
                        }
                    };

                    initializeFirebase();
                }, []);

                const handleAdminLoginSuccess = () => {
                    setIsAdminLoggedIn(true);
                    setShowAdminLoginModal(false);
                };

                const handleAdminLogout = () => {
                    setIsAdminLoggedIn(false);
                    setView('dashboard'); // Redirect to dashboard on logout
                };

                if (loading) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                            <div className="text-center text-gray-700">
                                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto mb-4"></div>
                                <p>Loading application...</p>
                            </div>
                        </div>
                    );
                }

                if (error) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-red-100 p-4">
                            <div className="text-center text-red-700">
                                <p className="font-bold text-lg mb-2">Error:</p>
                                <p>{error}</p>
                                <p className="mt-4 text-sm">Please refresh the page or contact support.</p>
                            </div>
                        </div>
                    );
                }

                return (
                    <FirebaseContext.Provider value={{ db, auth, userId, isAuthReady }}>
                        <ToastProvider> {/* Wrap the entire app with ToastProvider */}
                            <div className="min-h-screen bg-gray-100 font-sans antialiased text-gray-800">
                                <Header setView={setView} isAdminLoggedIn={isAdminLoggedIn} onAdminLogout={handleAdminLogout} onAdminLoginClick={() => setShowAdminLoginModal(true)} />
                                <main className="container mx-auto p-4 sm:p-6 lg:p-8">
                                    {view === 'dashboard' && <Dashboard setView={setView} setSelectedProjectId={setSelectedProjectId} isAdminLoggedIn={isAdminLoggedIn} />}
                                    {view === 'projects' && <Projects setView={setView} setSelectedProjectId={setSelectedProjectId} isAdminLoggedIn={isAdminLoggedIn} />}
                                    {view === 'newProject' && <ProjectForm setView={setView} setSelectedProjectId={setSelectedProjectId} />} {/* Use ProjectForm for new projects */}
                                    {view === 'editProject' && selectedProjectId && <ProjectForm projectId={selectedProjectId} setView={setView} setSelectedProjectId={setSelectedProjectId} />} {/* Use ProjectForm for editing */}
                                    {view === 'projectDetail' && selectedProjectId && <ProjectDetail projectId={selectedProjectId} setView={setView} isAdminLoggedIn={isAdminLoggedIn} />}
                                    {view === 'templateEditor' && <TemplateEditor setView={setView} setGeneratedReportData={setGeneratedReportData} isAdminLoggedIn={isAdminLoggedIn} />}
                                    {view === 'createBilling' && <CreateBillingForm setView={setView} setGeneratedReportData={setGeneratedReportData} initialReportData={generatedReportData} isAdminLoggedIn={isAdminLoggedIn} />}
                                    {view === 'viewReport' && generatedReportData && <BillingReportDisplay reportData={generatedReportData} setView={setView} setGeneratedReportData={setGeneratedReportData} />}
                                    {view === 'createExpenseReport' && <CreateExpenseReportForm setView={setView} setGeneratedExpenseReportData={setGeneratedExpenseReportData} isAdminLoggedIn={isAdminLoggedIn} />} {/* New Expense Report Form */}
                                    {view === 'viewExpenseReport' && generatedExpenseReportData && <ExpenseReportDisplay reportData={generatedExpenseReportData} setView={setView} />} {/* New Expense Report Display */}
                                </main>
                                <footer className="bg-gray-800 text-white py-4 mt-8 rounded-t-lg shadow-lg">
                                    <div className="container mx-auto text-center text-sm opacity-80">
                                        &copy; 2024 DLV Electrical Services Co. All rights reserved.
                                    </div>
                                </footer>
                            </div>
                            {showAdminLoginModal && (
                                <AdminLoginModal
                                    onClose={() => setShowAdminLoginModal(false)}
                                    onLoginSuccess={handleAdminLoginSuccess}
                                />
                            )}
                        </ToastProvider>
                    </FirebaseContext.Provider>
                );
            };

            // Render the App component into the 'root' div
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        };
    </script>
</body>
</html>
